(function(){"use strict";function d(o,r){var f;const s=r.toLowerCase(),c=o.toLowerCase();if(s.includes("jpeg")||s.includes("jpg"))return"jpeg";if(s.includes("png"))return"png";if(s.includes("webp"))return"webp";if(s.includes("avif"))return"avif";const e=(f=c.split(".").pop())==null?void 0:f.toLowerCase();return e==="jpg"||e==="jpeg"?"jpeg":e==="png"?"png":e==="webp"?"webp":e==="avif"?"avif":"jpeg"}function u(o,r,s){return s.preserveFormat?d(o,r):s.format}async function h(o){const{fileData:r,fileName:s,fileType:c,settings:e}=o,f=new Blob([r],{type:c}),p=await createImageBitmap(f);let t=p.width,i=p.height;if(e.resize.mode==="preset"&&e.resize.preset){const n=e.resize.preset;t>i?t>n&&(i=i*n/t,t=n):i>n&&(t=t*n/i,i=n)}else if(e.resize.mode==="custom")if(e.resize.width&&e.resize.height)if(e.resize.preserveAspectRatio){const n=Math.min(e.resize.width/t,e.resize.height/i);t=t*n,i=i*n}else t=e.resize.width,i=e.resize.height;else e.resize.width?(i=i*e.resize.width/t,t=e.resize.width):e.resize.height&&(t=t*e.resize.height/i,i=e.resize.height);const g=new OffscreenCanvas(t,i),a=g.getContext("2d");if(!a)throw new Error("Failed to get canvas context");const l=u(s,c,e);l==="jpeg"?(a.fillStyle=e.backgroundColor,a.fillRect(0,0,t,i)):a.clearRect(0,0,t,i),a.drawImage(p,0,0,t,i);const m=await g.convertToBlob({type:`image/${l}`,quality:e.quality/100});return p.close(),m}self.addEventListener("message",async o=>{const r=o.data;try{self.postMessage({type:"progress",id:r.id,progress:30});const s=await h(r);self.postMessage({type:"progress",id:r.id,progress:90}),self.postMessage({type:"success",id:r.id,blob:s,size:s.size})}catch(s){self.postMessage({type:"error",id:r.id,error:s instanceof Error?s.message:"Conversion failed"})}})})();

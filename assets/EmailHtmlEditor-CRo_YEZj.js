var dt=Object.defineProperty;var gt=(a,e,t)=>e in a?dt(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var A=(a,e,t)=>gt(a,typeof e!="symbol"?e+"":e,t);import{c as Le,j as i,p as h,q as ke,r as je,s as F,t as Me,v as S,B as y,o as D,w as Oe,x as xe,I as ye,f as De,g as Ee,P as ht,W as Pe,T as x,d as Ae,y as ge,z as U,D as ae,L as pt,C as ft,G as mt,H as bt,J as le,K as Ve,M as re,N as ce,A as pe,Q as V,U as Te,X as xt,F as Ge,l as ze,Y as Ue,Z as W,h as $e,i as yt,_ as Et,$ as At,a0 as Tt,a1 as St,a2 as vt,a3 as _t,a4 as Ct,a5 as It,k as Rt,a6 as wt,a7 as Lt,a8 as kt,a9 as jt,aa as Be,ab as Se,ac as ve,ad as Mt,ae as We,n as Xe,af as _e,R as $t,ag as Ft,u as Ht,ah as Nt,ai as Ot,S as Ze,aj as Dt,ak as Pt,al as Vt,am as Gt}from"./index-CU1ToNlc.js";const Ye=Le(i.jsx("path",{d:"M12 2c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2m9 7h-6v13h-2v-6h-2v6H9V9H3V7h18z"}),"Accessibility"),he=Le(i.jsx("path",{d:"M20 8h-2.81c-.45-.78-1.07-1.45-1.82-1.96L17 4.41 15.59 3l-2.17 2.17C12.96 5.06 12.49 5 12 5c-.49 0-.96.06-1.41.17L8.41 3 7 4.41l1.62 1.63C7.88 6.55 7.26 7.22 6.81 8H4v2h2.09c-.05.33-.09.66-.09 1v1H4v2h2v1c0 .34.04.67.09 1H4v2h2.81c1.04 1.79 2.97 3 5.19 3s4.15-1.21 5.19-3H20v-2h-2.09c.05-.33.09-.66.09-1v-1h2v-2h-2v-1c0-.34-.04-.67-.09-1H20zm-6 8h-4v-2h4zm0-4h-4v-2h4z"}),"BugReport"),Ke=Le(i.jsx("path",{d:"M10 18h4v-2h-4zM3 6v2h18V6zm3 7h12v-2H6z"}),"FilterList"),T={DEFAULT_IMAGE_WIDTH:600,DEFAULT_IMAGE_HEIGHT:400,DEFAULT_ALT_TEXT:"Image",MAX_TABLES:50,MAX_TABLE_NESTING:5,MAX_AUTOFIX_ITERATIONS:10,MAX_STYLE_MERGE_ITERATIONS:3,MAX_FILE_SIZE_KB:102,MAX_HTML_SIZE_KB:130,MAX_HTML_SIZE_BYTES:133120,REGEX_CACHE_SIZE:100,AST_CACHE_SIZE:50,TRAVERSAL_CACHE_SIZE:50,CACHE_TTL_MS:5*60*1e3,CACHE_CLEANUP_INTERVAL_MS:10*60*1e3,DEFAULT_LINK_STYLES:"color:#0000ff; text-decoration:none;",DEFAULT_IMAGE_STYLES:"display:block",HEADING_FONT_SIZES:{h1:32,h2:24,h3:20,h4:18,h5:16,h6:14},TARGET_CLIENTS:{outlook:!0,gmail:!0,applemail:!0,thunderbird:!1,mobile:!0}},R={MAX_PARSER_ITERATIONS:1e3,MAX_PARSER_DEPTH:100,MAX_PARSER_SAFETY_COUNTER:1e4,MAX_VALIDATION_RESULTS:1e3,MAX_TRAVERSAL_RESULTS:1e3,MAX_AUTOFIX_ITERATIONS:50,MAX_AUTOFIX_MULTIPLE_ITERATIONS:25,MAX_HTML_SIZE_INCREASE_MULTIPLIER:3,MAX_AUTOFIX_PASSES:3,CACHE_CLEANUP_PERCENTAGE:.3,CACHE_CLEANUP_PERCENTAGE_REDUCED:.2,CACHE_CLEANUP_THRESHOLD:.8,CACHE_CLEANUP_PERCENTAGE_LARGE:.4,MAX_FIX_HISTORY_SIZE:100,MAX_FIX_HISTORY_AGE_MS:30*60*1e3,MAX_CUSTOM_RULES_SIZE:100,MAX_STRING_BATCHER_OPERATIONS:50,SLOW_VALIDATION_THRESHOLD_MS:1e3,SLOW_AUTOFIX_THRESHOLD_MS:2e3,MAX_HEADING_LEVELS:6,MAX_RECENT_FIXES_TRACKED:10},ee={MAX_SCORE:100,MAX_PENALTY:100,ERROR_PENALTY:20,WARNING_PENALTY:10,INFO_PENALTY:5},O={REGEX_ACCESS_COUNT_WEIGHT:.3,REGEX_AGE_WEIGHT:.7,AST_ACCESS_COUNT_WEIGHT:.4,AST_AGE_WEIGHT:.6,TRAVERSAL_ACCESS_COUNT_WEIGHT:.2,TRAVERSAL_AGE_WEIGHT:.5,TRAVERSAL_SIZE_WEIGHT:.3},qe={STYLE_ATTRIBUTE:/style="([^"]*)"/gi,WIDTH_100_PERCENT:/width:\s*100%/gi,EMPTY_HREF:/href\s*=\s*["']?\s*["']?/gi,MALFORMED_SRC:/\bs\s+rc=/gi,MALFORMED_HREF_NO_EQUALS:/\s+href\s+([^"\s>]+)/gi,MALFORMED_HREF_WITH_QUOTES:/\s+href\s+"([^"]*)"([^>]*)/gi,DEFAULT_HREF_VALUE:"urlhere"},zt={TEN_MINUTES_MS:10*60*1e3},w={HTML_TOO_LARGE:"HTML is too large for validation",HTML_TOO_LARGE_FOR_AUTOFIX:"HTML too large for autofix",VALIDATION_FAILED:"Validation failed",AUTOFIX_FAILED:"Autofix failed",RULE_NOT_FOUND:"Rule not found",INVALID_HTML_INPUT:"Invalid HTML input: must be a non-empty string",INVALID_RULE_NAME:"Rule name is required",INVALID_SEVERITY:"Invalid severity level. Must be error, warning, or info",INVALID_CONFIG:"Invalid configuration provided",VALIDATOR_DISPOSED:"EmailHTMLValidator has been disposed and cannot be used"},te={SLOW_OPERATION_PREFIX:"Slow operation detected",CACHE_CLEANUP_PREFIX:"Cache cleanup completed",STATISTICS_RESET_PREFIX:"Statistics reset",DISPOSAL_PREFIX:"disposed successfully",GARBAGE_COLLECTION_PREFIX:"Garbage collection triggered"};class g{static get(e,t="gi"){const r=`${e}|${t}`;if(this.cache.has(r)){const s=this.accessCount.get(r)||0;this.accessCount.set(r,s+1),this.lastAccess.set(r,Date.now())}else{this.cache.size>=this.maxSize&&this.performCleanup();try{const s=new RegExp(e,t);this.cache.set(r,s),this.accessCount.set(r,1),this.lastAccess.set(r,Date.now()),this.precompiledPatterns.has(e)||this.precompiledPatterns.add(e)}catch(s){h.warn("RegexCache",`Invalid regex pattern: ${e}`,s),this.cache.set(r,new RegExp("(?:)",t)),this.accessCount.set(r,1),this.lastAccess.set(r,Date.now())}}return this.cleanupTimer||(this.cleanupTimer=setTimeout(()=>{this.performCleanup(),this.cleanupTimer=void 0},T.CACHE_CLEANUP_INTERVAL_MS)),this.cache.get(r)}static performCleanup(){if(this.cache.size<=this.maxSize*R.CACHE_CLEANUP_THRESHOLD)return;const e=Array.from(this.cache.entries()).map(([r,s])=>({key:r,regex:s,accessCount:this.accessCount.get(r)||0,lastAccess:this.lastAccess.get(r)||0,age:Date.now()-(this.lastAccess.get(r)||0)}));e.sort((r,s)=>{const l=r.accessCount*O.REGEX_ACCESS_COUNT_WEIGHT+r.age/1e3*O.REGEX_AGE_WEIGHT,o=s.accessCount*O.REGEX_ACCESS_COUNT_WEIGHT+s.age/1e3*O.REGEX_AGE_WEIGHT;return l-o});const t=Math.floor(this.cache.size*R.CACHE_CLEANUP_PERCENTAGE);for(let r=0;r<t&&r<e.length;r++){const s=e[r];this.cache.delete(s.key),this.accessCount.delete(s.key),this.lastAccess.delete(s.key)}}static clear(){this.cache.clear(),this.accessCount.clear(),this.lastAccess.clear(),this.cleanupTimer&&(clearTimeout(this.cleanupTimer),this.cleanupTimer=void 0)}static size(){return this.cache.size}static getStats(){const e=Math.min(...Array.from(this.lastAccess.values()));return{size:this.cache.size,maxSize:this.maxSize,accessCount:Array.from(this.accessCount.values()).reduce((t,r)=>t+r,0),oldestEntry:e===1/0?0:e}}}A(g,"cache",new Map),A(g,"maxSize",T.REGEX_CACHE_SIZE),A(g,"precompiledPatterns",new Set),A(g,"accessCount",new Map),A(g,"lastAccess",new Map),A(g,"cleanupTimer");class Q{static get(e){const t=this.hashCode(e),r=this.cache.get(t);if(r){if(Date.now()-r.timestamp>this.ttl){this.cache.delete(t);return}return r.accessCount++,this.cleanupTimer||(this.cleanupTimer=setTimeout(()=>{this.clearExpired(),this.cleanupTimer=void 0},T.CACHE_CLEANUP_INTERVAL_MS)),r.ast}}static set(e,t){const r=this.hashCode(e);this.cache.size>=this.maxSize&&this.performCleanup(),this.cache.set(r,{ast:t,timestamp:Date.now(),accessCount:1})}static clear(){this.cache.clear(),this.cleanupTimer&&(clearTimeout(this.cleanupTimer),this.cleanupTimer=void 0)}static size(){return this.cache.size}static clearExpired(){const e=Date.now();let t=0;const r=[];for(const[s,l]of this.cache.entries())e-l.timestamp>this.ttl&&r.push(s);for(const s of r)this.cache.delete(s),t++;return this.cache.size>this.maxSize*R.CACHE_CLEANUP_THRESHOLD&&this.performCleanup(),t}static performCleanup(){if(this.cache.size<=this.maxSize*R.CACHE_CLEANUP_THRESHOLD)return;const e=Array.from(this.cache.entries()).map(([r,s])=>({key:r,...s,age:Date.now()-s.timestamp}));e.sort((r,s)=>{const l=r.accessCount*O.AST_ACCESS_COUNT_WEIGHT+r.age/1e3*O.AST_AGE_WEIGHT,o=s.accessCount*O.AST_ACCESS_COUNT_WEIGHT+s.age/1e3*O.AST_AGE_WEIGHT;return l-o});const t=Math.floor(this.cache.size*R.CACHE_CLEANUP_PERCENTAGE);for(let r=0;r<t&&r<e.length;r++)this.cache.delete(e[r].key)}static hashCode(e){if(e.length===0)return"0";let t=0;for(let r=0;r<e.length;r++){const s=e.charCodeAt(r);t=(t<<5)-t+s,t=t&t}return`${Math.abs(t)}_${e.length}`}static getStats(){const e=Math.min(...Array.from(this.cache.values()).map(t=>t.timestamp));return{size:this.cache.size,maxSize:this.maxSize,ttl:this.ttl,oldestEntry:e===1/0?0:e}}}A(Q,"cache",new Map),A(Q,"maxSize",T.AST_CACHE_SIZE),A(Q,"ttl",T.CACHE_TTL_MS),A(Q,"cleanupTimer");class Ce{constructor(){A(this,"operations",[]);A(this,"maxOperations",R.MAX_STRING_BATCHER_OPERATIONS)}add(e,t){return this.operations.length>=this.maxOperations&&this.execute(""),this.operations.push({pattern:e,replacement:t}),this}execute(e){let t=e;try{for(const r of this.operations)t=t.replace(r.pattern,r.replacement)}catch(r){return h.warn("StringBatcher","Execution error",r),e}finally{this.clear()}return t}clear(){this.operations=[]}getOperationCount(){return this.operations.length}}class Re{constructor(e){A(this,"html");A(this,"position");A(this,"line");A(this,"column");this.html=e,this.position=0,this.line=1,this.column=1}parse(){const e=[],t=R.MAX_PARSER_ITERATIONS;let r=0;try{for(;this.position<this.html.length&&r<t;){r++;const s=this.parseNode();if(s&&e.push(s),this.position>=this.html.length)break;if(r>=t){h.warn("SimpleHTMLParser","Reached max iterations, stopping to prevent infinite loop",{iterations:r,maxIterations:t});break}}}catch(s){h.warn("SimpleHTMLParser","Parser error",s)}return e}parseNode(){return this.skipWhitespace(),this.position>=this.html.length?null:this.html[this.position]==="<"?this.html.substr(this.position,4)==="<!--"?this.parseComment():this.parseElement():this.parseText()}parseElement(){const e=this.line,t=this.column;if(this.html[this.position]!=="<")return null;if(this.advance(),this.html[this.position]==="/")return this.advance(),this.parseTagName()&&this.html[this.position]===">"&&this.advance(),null;const s=this.parseTagName();if(!s)return null;const l=this.parseAttributes(),o=this.html[this.position]==="/";o&&this.advance(),this.html[this.position]===">"&&this.advance();const n={type:"element",tagName:s.toLowerCase(),attributes:l,line:e,column:t,children:[]};return!o&&!this.isSelfClosingTag(s)&&(n.children=this.parseChildren(s)),n}parseTagName(){let e="";for(;this.position<this.html.length&&/[a-zA-Z0-9]/.test(this.html[this.position]);)e+=this.html[this.position],this.advance();return e}parseAttributes(){const e={};let t=0;for(;this.position<this.html.length&&this.html[this.position]!==">"&&this.html[this.position]!=="/";){const r=this.position;if(this.skipWhitespace(),this.position>=this.html.length||this.html[this.position]===">"||this.html[this.position]==="/")break;const s=this.parseAttribute();if(s&&(e[s.name]=s.value),this.position===r&&this.advance(),t++,t>R.MAX_PARSER_SAFETY_COUNTER)break}return e}parseAttribute(){const e=this.parseAttributeName();if(!e)return null;if(this.skipWhitespace(),this.position>=this.html.length)return{name:e,value:""};if(this.html[this.position]!=="=")return{name:e,value:""};this.advance(),this.skipWhitespace();const t=this.parseAttributeValue();return{name:e,value:t}}parseAttributeName(){let e="";for(;this.position<this.html.length&&/[a-zA-Z0-9\-_:]/.test(this.html[this.position]);)e+=this.html[this.position],this.advance();return e}parseAttributeValue(){if(this.position>=this.html.length)return"";const e=this.html[this.position];if(e==='"'||e==="'"){this.advance();let r="";for(;this.position<this.html.length&&this.html[this.position]!==e;)r+=this.html[this.position],this.advance();return this.position<this.html.length&&this.html[this.position]===e&&this.advance(),r}let t="";for(;this.position<this.html.length&&!/[\s>]/.test(this.html[this.position]);)t+=this.html[this.position],this.advance();return t}parseChildren(e){const t=[],r=R.MAX_PARSER_DEPTH;let s=0;const l=this.position;for(;this.position<this.html.length&&s<r;){if(s++,this.position===l&&s>1&&this.advance(),this.html.substr(this.position,2+e.length+1)===`</${e}>`){this.position+=2+e.length+1,this.updatePosition();break}const o=this.parseNode();if(o)t.push(o);else{this.position<this.html.length&&this.advance();break}if(this.position>=this.html.length)break}return t}parseText(){const e=this.line,t=this.column;let r="";for(;this.position<this.html.length&&this.html[this.position]!=="<";)r+=this.html[this.position],this.advance();return{type:"text",content:r.trim(),line:e,column:t}}parseComment(){const e=this.line,t=this.column;this.position+=4;let r="";for(;this.position<this.html.length&&this.html.substr(this.position,3)!=="-->";)r+=this.html[this.position],this.advance();return this.position<this.html.length&&this.html.substr(this.position,3)==="-->"&&(this.position+=3,this.updatePosition()),{type:"comment",content:r,line:e,column:t}}isSelfClosingTag(e){return["br","img","hr","area","base","col","input"].includes(e.toLowerCase())}skipWhitespace(){for(;this.position<this.html.length&&/\s/.test(this.html[this.position]);)this.advance()}advance(){this.position>=this.html.length||(this.html[this.position]===`
`?(this.line++,this.column=1):this.column++,this.position++)}updatePosition(){for(let e=0;e<3&&this.position-3+e>=0;e++)this.html[this.position-3+e]===`
`?(this.line++,this.column=1):this.column++}}function q(a,e){if(Array.isArray(a))for(const t of a)t&&(e(t),t.children&&Array.isArray(t.children)&&t.children.length>0&&q(t.children,e))}function ue(a,e){if(!Array.isArray(a)||!e)return[];const t=[];return q(a,r=>{r.type==="element"&&r.tagName===e.toLowerCase()&&t.push(r)}),t}const H={TAG_OPENING:a=>`<${a}(?:\\s[^>]*)?>`,TAG_CLOSING:a=>`</${a}>`,TAG_SELF_CLOSING:a=>`<${a}(?:\\s[^>]*)?/>`,TAG_WITH_CONTENT:a=>`<${a}(?:\\s[^>]*)?>[\\s\\S]*?</${a}>`,ATTRIBUTE_STYLE_DUPLICATE:'style="([^"]*)"([^>]*?)style="([^"]*)"',ATTRIBUTE_EMPTY_HREF:`href\\s*=\\s*(?:"\\s*"|'\\s*'|\\s*)`,ATTRIBUTE_TARGET_WRONG:`target\\s*=\\s*(?:"(?:_self|_parent|_top)"|'(?:_self|_parent|_top)')`,ATTRIBUTE_MALFORMED_SRC:"\\bs\\s+rc=",ATTRIBUTE_MISSING_SPACE:'="([^"]*)"([a-zA-Z]+=)',IMG_MALFORMED_ATTR_SPACING:'(<img[^>]*?)([a-zA-Z0-9_.-]+")([a-zA-Z]+=)',IMG_SELF_CLOSING_WRONG:"<img\\s*([^>]*?)></img>",IMG_MISSING_ALT:"<img(?![^>]*\\salt=)[^>]*>",IMG_MISSING_WIDTH:"<img(?![^>]*\\swidth=)[^>]*>",IMG_MISSING_HEIGHT:"<img(?![^>]*\\sheight=)[^>]*>",LINK_EMPTY_HREF:`<a[^>]*href\\s*=\\s*(?:"\\s*"|'\\s*'|\\s*)[^>]*>`,LINK_NO_TARGET:`<a[^>]*href\\s*=\\s*(?:"[^"]+"|'[^']+')[^>]*(?!target\\s*=)[^>]*>`,LINK_NO_STYLE:`<a[^>]*href\\s*=\\s*(?:"[^"]+"|'[^']+')[^>]*(?!style\\s*=)[^>]*>`,TABLE_NESTED_EXCESSIVE:"<table([^>]*)><tr><td([^>]*)><table([^>]*)><tr><td([^>]*)>",TABLE_NESTED_CLOSING:"</td></tr></table></td></tr></table>",TABLE_EMPTY:"<table[^>]*><tr><td[^>]*>\\s*</td></tr></table>",TABLE_SINGLE_SPAN_WRAPPER:"<table[^>]*><tr><td[^>]*>(\\s*<span[^>]*>[^<]+</span>\\s*)</td></tr></table>",STYLE_WIDTH_PERCENTAGE:'style="([^"]*?)width:\\s*100%([^"]*?)"',EMPTY_SPAN:"<span[^>]*>\\s*</span>",EMPTY_SPAN_WHITESPACE:"<span[^>]*>[\\s\\t\\n\\r]*</span>",EXTRA_SPACES_IN_TAG:"\\s+>",EXTRA_SPACES_MULTIPLE:"\\s{2,}",UNSAFE_ATTRIBUTE:a=>`\\s${a}\\s*=\\s*(?:"[^"]*"|'[^']*')`},we={GLOBAL_CASE_INSENSITIVE:"gi",GLOBAL_CASE_INSENSITIVE_MULTILINE:"gim",GLOBAL_CASE_INSENSITIVE_DOTALL:"gis",CASE_INSENSITIVE:"i",GLOBAL:"g"},Ut=["table","tbody","thead","tfoot","tr","td","th","img","a","span","strong","b","em","i","u","br","center","font","big","small","sup","sub","ul","ol","li","blockquote","pre"],de=["div","p","h1","h2","h3","h4","h5","h6","section","article","aside","nav","header","footer","main","figure","figcaption","canvas","svg","video","audio","iframe","embed","object","script","form","input","button","textarea","select","option","fieldset","legend","label"],Bt={table:['cellpadding="0"','cellspacing="0"','border="0"'],img:["alt",'style="display:block"'],a:['target="_blank"'],td:['valign="top"']},k={isValidHtml:a=>!!(a&&typeof a=="string"),createValidationResult:(a,e,t,r,s,l,o)=>({rule:a,severity:e,message:t,suggestion:r,autoFixAvailable:!0,category:s,line:l,column:o}),hasPattern:(a,e,t=we.GLOBAL_CASE_INSENSITIVE)=>{if(!k.isValidHtml(a))return!1;try{const r=t.replace("g","");return g.get(e,r).test(a)}catch{return!1}},findPatternMatches:(a,e,t=we.GLOBAL_CASE_INSENSITIVE)=>{const r=[];if(!k.isValidHtml(a))return r;try{const s=t.includes("g")?t:`${t}g`,l=g.get(e,s);for(const o of a.matchAll(l))r.push(o)}catch{}return r},checkForbiddenTagsAST:(a,e,t,r)=>{if(!a||!Array.isArray(e))return;const s=l=>{for(const o of l)o.type==="element"&&o.tagName&&e.includes(o.tagName)&&r(o,o.tagName),o.children&&Array.isArray(o.children)&&s(o.children)};s(a)},checkForbiddenTagsRegex:(a,e,t,r)=>{!k.isValidHtml(a)||!Array.isArray(e)||e.forEach(s=>{const l=H.TAG_OPENING(s);k.findPatternMatches(a,l).length>0&&r(s)})}},Wt={replaceTagsWithSpans:(a,e)=>{if(!k.isValidHtml(a))return a;let t=a;try{Object.entries(e).forEach(([r,s])=>{const l=`<${r}((?:\\s[^>]*)?)>`,o=H.TAG_CLOSING(r),n=Object.entries(s).map(([u,c])=>{switch(u){case"fontSize":return`font-size: ${c}px`;case"fontWeight":return`font-weight: ${c}`;case"display":return`display: ${c}`;default:return`${u}: ${c}`}}).join("; ");t=t.replace(g.get(l,"gi"),(u,c)=>{const m=c.match(/style\s*=\s*["']([^"']*)["']/i);let E=n;if(m){const f=m[1].replace(/;\s*$/,""),v={};f.split(";").forEach(I=>{const[_,L]=I.split(":").map(j=>j.trim());_&&L&&(v[_]=L)}),n.split(";").forEach(I=>{const[_,L]=I.split(":").map(j=>j.trim());_&&L&&(v[_]=L)}),E=Object.entries(v).map(([I,_])=>`${I}: ${_}`).join("; "),c=c.replace(/\s*style\s*=\s*["'][^"']*["']/gi,"")}return`<span${c} style="${E};">`}),t=t.replace(g.get(o,"gi"),"</span>")})}catch{}return t},replaceBlockElementsWithTables:(a,e)=>{if(!k.isValidHtml(a))return a;let t=a;try{Array.isArray(e)&&e.forEach(r=>{const s=H.TAG_OPENING(r),l=H.TAG_CLOSING(r);t=t.replace(g.get(s),'<table cellpadding="0" cellspacing="0" border="0"$1><tr><td valign="top">'),t=t.replace(g.get(l),"</td></tr></table>")})}catch{}return t},removeDangerousTags:(a,e)=>{if(!k.isValidHtml(a))return a;let t=a;try{Array.isArray(e)&&e.forEach(r=>{const s=H.TAG_WITH_CONTENT(r),l=H.TAG_SELF_CLOSING(r);t=t.replace(g.get(s,we.GLOBAL_CASE_INSENSITIVE_DOTALL),""),t=t.replace(g.get(l),"")})}catch{}return t},cleanupTableNesting:(a,e=10)=>{if(!k.isValidHtml(a))return a;let t=a;try{let r,s=0;do r=t,t=t.replace(g.get(H.TABLE_NESTED_EXCESSIVE),"<table$1><tr><td$2>"),t=t.replace(g.get(H.TABLE_NESTED_CLOSING),"</td></tr></table>"),s++;while(r!==t&&s<e);t=t.replace(g.get(H.TABLE_EMPTY),""),t=t.replace(g.get(H.TABLE_SINGLE_SPAN_WRAPPER),"$1")}catch{}return t},mergeDuplicateStyles:(a,e=3)=>{if(!k.isValidHtml(a))return a;let t=a;try{let r,s=0;do r=t,t=t.replace(g.get(H.ATTRIBUTE_STYLE_DUPLICATE),(l,o,n,u)=>{var _;const c=o.split(";").filter(L=>L.trim()),m=u.split(";").filter(L=>L.trim()),E=[...c,...m],f=[],v=new Set;for(const L of E.reverse()){const j=(_=L.split(":")[0])==null?void 0:_.trim();j&&!v.has(j)&&(v.add(j),f.unshift(L.trim()))}return`style="${f.join("; ")}"${n}`}),s++;while(r!==t&&s<e)}catch{}return t},removeEmptyElements:a=>{if(!k.isValidHtml(a))return a;let e=a;try{e=e.replace(g.get(H.EMPTY_SPAN),""),e=e.replace(g.get(H.EMPTY_SPAN_WHITESPACE),"")}catch{}return e}},Xt={h1:32,h2:24,h3:20,h4:18,h5:16,h6:14},$={"forbidden-tags":{name:"forbidden-tags",displayName:"Forbidden HTML Tags (Legacy)",description:"Legacy rule - replaced by specific rules (heading-tags, paragraph-tags, etc.)",severity:"error",enabled:!1,configurable:!0,category:"structure",config:{allowedTags:Ut,forbiddenTags:de},check:(a,e={})=>{const t=[];if(!a||typeof a!="string")return t;try{const s=new Re(a).parse(),l=e.forbiddenTags||de;q(s,o=>{o.type==="element"&&o.tagName&&Array.isArray(l)&&l.includes(o.tagName)&&t.push({rule:"forbidden-tags",severity:"error",message:`Tag "${o.tagName}" is not email-safe`,line:o.line,column:o.column,suggestion:Ie(o.tagName),autoFixAvailable:!0,category:"structure"})})}catch{const s=e.forbiddenTags||de;Array.isArray(s)&&s.forEach(l=>{const o=g.get(`<${l}(?:\\s[^>]*)?>`,"gi"),n=a.match(o);n&&n.forEach(()=>{t.push({rule:"forbidden-tags",severity:"error",message:`Tag "${l}" is not email-safe`,suggestion:Ie(l),autoFixAvailable:!0,category:"structure"})})})}return t},checkWithAST:(a,e,t={})=>{const r=[];if(!a||typeof a!="string"||!e)return r;try{const s=t.forbiddenTags||de;q(e,l=>{l.type==="element"&&l.tagName&&Array.isArray(s)&&s.includes(l.tagName)&&r.push({rule:"forbidden-tags",severity:"error",message:`Tag "${l.tagName}" is not email-safe`,line:l.line,column:l.column,suggestion:Ie(l.tagName),autoFixAvailable:!0,category:"structure"})})}catch{return $["forbidden-tags"].check(a,t)}return r},autofix:a=>{if(!a||typeof a!="string")return a;let e=a;try{for(let o=1;o<=R.MAX_HEADING_LEVELS;o++){const n=g.get(`<h${o}([^>]*)>`),u=g.get(`</h${o}>`);e=e.replace(n,`<span$1 style="font-weight: bold; font-size: ${Zt(o)}px;">`),e=e.replace(u,"</span>")}e=e.replace(g.get("<p([^>]*)>"),"<span$1>"),e=e.replace(g.get("</p>"),"</span>");const t=["div","section","article","nav","header","footer","main","aside","figure","figcaption"],r=(e.match(/<table/g)||[]).length,s=T.MAX_TABLES;r<s&&t.forEach(o=>{const n=g.get(`<${o}((?:\\s[^>]*)?)>`),u=g.get(`</${o}>`);e=e.replace(n,'<table cellpadding="0" cellspacing="0" border="0"$1><tr><td valign="top">'),e=e.replace(u,"</td></tr></table>")}),["script","style","form","input","button","textarea","select","option","fieldset","legend","label","video","audio","canvas","svg","iframe","embed","object","base","col","area"].forEach(o=>{const n=g.get(`<${o}(?:\\s[^>]*)?>(?:[\\s\\S]*?)</${o}>`,"gi");e=e.replace(n,"");const u=g.get(`<${o}(?:\\s[^>]*)?/>`,"gi");e=e.replace(u,"")});for(let o=0;o<T.MAX_STYLE_MERGE_ITERATIONS;o++){const n=e;if(e=e.replace(g.get('style="([^"]*?)"([^>]*?)style="([^"]*?)"'),(u,c,m,E)=>{var se;const f=c.split(";").filter(N=>N.trim()),v=E.split(";").filter(N=>N.trim()),I=[...f,...v],_=[],L=new Set;for(const N of I){const P=(se=N.split(":")[0])==null?void 0:se.trim();P&&!L.has(P)&&(L.add(P),_.push(N.trim()))}return`style="${_.join("; ")}"${m}`}),n===e)break}for(let o=0;o<T.MAX_AUTOFIX_ITERATIONS;o++){const n=e;if(e=e.replace(g.get("<table([^>]*?)><tr><td([^>]*?)><table([^>]*?)><tr><td([^>]*?)>"),"<table$1><tr><td$2>"),e=e.replace(g.get("<\\/td><\\/tr><\\/table><\\/td><\\/tr><\\/table>"),"</td></tr></table>"),n===e)break}e=e.replace(g.get("<table[^>]*><tr><td[^>]*>\\s*<\\/td><\\/tr><\\/table>"),""),e=e.replace(g.get("<table[^>]*><tr><td[^>]*>(\\s*<span[^>]*>[^<]+<\\/span>\\s*)<\\/td><\\/tr><\\/table>"),"$1"),e=e.replace(g.get("<span[^>]*>\\s*<\\/span>"),""),e=e.replace(g.get("<span[^>]*>[\\s\\t\\n\\r]*<\\/span>"),""),e=e.replace(g.get("\\bs\\s+rc="),"src="),e=e.replace(g.get("\\bS\\s+RC="),"src="),e=e.replace(g.get('="([^"]*)"([a-zA-Z]+=)'),'="$1" $2'),e=e.replace(g.get('(<img[^>]*?)([a-zA-Z0-9_.-]+")([a-zA-Z]+=)'),"$1$2 $3")}catch{}return e=e.replace(g.get("\\bs\\s+rc="),"src="),e=e.replace(g.get("\\bS\\s+RC="),"src="),e}},"email-safe-tags":{name:"email-safe-tags",displayName:"Email-Safe Tag Format",description:"Ensures tags are formatted correctly for email clients",severity:"error",enabled:!0,configurable:!1,category:"structure",check:a=>{const e=[];if(!a||typeof a!="string")return e;try{["br","hr"].forEach(s=>{const l=g.get(`<${s}\\s*[^>]*><\\/${s}>`),o=a.match(l);o&&o.forEach(()=>{e.push({rule:"email-safe-tags",severity:"error",message:`Tag "${s}" should not have closing tag in emails`,suggestion:`Replace <${s}></${s}> with <${s}>`,autoFixAvailable:!0,category:"structure"})});const n=g.get(`<${s}\\s*[^>]*\\/>`),u=a.match(n);u&&u.forEach(()=>{e.push({rule:"email-safe-tags",severity:"error",message:`Tag "${s}" should be open tag in emails, not self-closing`,suggestion:`Replace <${s}/> with <${s}>`,autoFixAvailable:!0,category:"structure"})})}),["img"].forEach(s=>{const l=g.get(`<${s}\\s*[^>]*><\\/${s}>`),o=a.match(l);o&&o.forEach(()=>{e.push({rule:"email-safe-tags",severity:"error",message:`Tag "${s}" should be self-closing`,suggestion:`Replace <${s}></${s}> with <${s} />`,autoFixAvailable:!0,category:"structure"})})})}catch{}return e},autofix:a=>{if(!a||typeof a!="string")return a;try{const e=new Ce;return e.add(g.get("<br\\s*[^>]*><\\/br>"),"<br>").add(g.get("<br\\s*[^>]*\\/>"),"<br>").add(g.get("<hr\\s*[^>]*><\\/hr>"),"<hr>").add(g.get("<hr\\s*[^>]*\\/>"),"<hr>").add(g.get("<img\\s*([^>]*?)><\\/img>"),"<img $1 />").add(g.get("<br\\/\\s*\\/>"),"<br>").add(g.get("<br\\s*\\/\\s*\\/>"),"<br>").add(g.get("<hr\\/\\s*\\/>"),"<hr>").add(g.get("<hr\\s*\\/\\s*\\/>"),"<hr>").add(g.get("(<img[^>]*?)\\s*\\/\\s*([^>]*?)>"),"$1$2 />").add(g.get(`(<img[^>]*?)([^"'])\\s*\\/\\s*([^>]*?)>`),"$1$2$3 />").add(g.get("<img([^>]*?)([^/])\\s*\\/\\s*\\/\\s*>"),"<img$1$2 />").add(g.get("(<img[^>]*?)\\s+\\/>","g"),"$1 />").add(g.get("(<img[^>]*?)([a-zA-Z])([a-zA-Z]+=)"),"$1$2 $3").add(g.get("\\s+(style|alt|src|class|width|height)=")," $1=").add(g.get(`=\\s*([^"'\\s>]+)`),'="$1"').add(g.get("\\s+>","gi"),">").add(g.get("<\\s+","gi"),"<").add(g.get("\\bs\\s+rc="),"src=").add(g.get("\\bS\\s+RC="),"src="),e.execute(a)}catch{return a}}},"table-attributes":{name:"table-attributes",displayName:"Required Table Attributes",description:"Ensures tables have required email-safe attributes",severity:"error",enabled:!0,configurable:!0,category:"structure",config:{requiredAttributes:Bt},check:a=>{const e=[];if(!a||typeof a!="string")return e;try{const r=new Re(a).parse();ue(r,"table").forEach(o=>{const n=o.attributes||{};(!n.cellpadding||n.cellpadding!=="0")&&e.push({rule:"table-attributes",severity:"error",message:'Table should have cellpadding="0"',line:o.line,column:o.column,suggestion:'Add cellpadding="0" to table tag',autoFixAvailable:!0,category:"structure"}),(!n.cellspacing||n.cellspacing!=="0")&&e.push({rule:"table-attributes",severity:"error",message:'Table should have cellspacing="0"',line:o.line,column:o.column,suggestion:'Add cellspacing="0" to table tag',autoFixAvailable:!0,category:"structure"}),(!n.border||n.border!=="0")&&e.push({rule:"table-attributes",severity:"error",message:'Table should have border="0"',line:o.line,column:o.column,suggestion:'Add border="0" to table tag',autoFixAvailable:!0,category:"structure"})}),ue(r,"img").forEach(o=>{const n=o.attributes||{};n.alt||e.push({rule:"table-attributes",severity:"error",message:"Image must have alt attribute",line:o.line,column:o.column,suggestion:'Add alt="" to img tag',autoFixAvailable:!0,category:"accessibility"}),n.width||e.push({rule:"table-attributes",severity:"error",message:"Image must have width attribute",line:o.line,column:o.column,suggestion:`Add width="${T.DEFAULT_IMAGE_WIDTH}" to img tag`,autoFixAvailable:!0,category:"structure"}),n.height||e.push({rule:"table-attributes",severity:"error",message:"Image must have height attribute",line:o.line,column:o.column,suggestion:`Add height="${T.DEFAULT_IMAGE_HEIGHT}" to img tag`,autoFixAvailable:!0,category:"structure"}),(!n.style||!n.style.includes("display:block"))&&e.push({rule:"table-attributes",severity:"error",message:'Image must have style="display:block"',line:o.line,column:o.column,suggestion:'Add style="display:block" to img tag',autoFixAvailable:!0,category:"structure"})})}catch{e.push({rule:"table-attributes",severity:"warning",message:"Unable to parse HTML for detailed checking",suggestion:'Check table attributes manually: cellpadding="0" cellspacing="0" border="0"',autoFixAvailable:!1,category:"structure"})}return e},checkWithAST:(a,e,t,r)=>{const s=[];if(!a||typeof a!="string"||!e)return s;try{((r==null?void 0:r.findNodesByTag("table"))||ue(e,"table")).forEach(n=>{const u=n.attributes||{};(!u.cellpadding||u.cellpadding!=="0")&&s.push({rule:"table-attributes",severity:"error",message:'Table should have cellpadding="0"',line:n.line,column:n.column,suggestion:'Add cellpadding="0" to table tag',autoFixAvailable:!0,category:"structure"}),(!u.cellspacing||u.cellspacing!=="0")&&s.push({rule:"table-attributes",severity:"error",message:'Table should have cellspacing="0"',line:n.line,column:n.column,suggestion:'Add cellspacing="0" to table tag',autoFixAvailable:!0,category:"structure"}),(!u.border||u.border!=="0")&&s.push({rule:"table-attributes",severity:"error",message:'Table should have border="0"',line:n.line,column:n.column,suggestion:'Add border="0" to table tag',autoFixAvailable:!0,category:"structure"})}),((r==null?void 0:r.findNodesByTag("img"))||ue(e,"img")).forEach(n=>{const u=n.attributes||{};u.alt||s.push({rule:"table-attributes",severity:"error",message:"Image must have alt attribute",line:n.line,column:n.column,suggestion:'Add alt="" to img tag',autoFixAvailable:!0,category:"accessibility"}),u.width||s.push({rule:"table-attributes",severity:"error",message:"Image must have width attribute",line:n.line,column:n.column,suggestion:`Add width="${T.DEFAULT_IMAGE_WIDTH}" to img tag`,autoFixAvailable:!0,category:"structure"}),u.height||s.push({rule:"table-attributes",severity:"error",message:"Image must have height attribute",line:n.line,column:n.column,suggestion:`Add height="${T.DEFAULT_IMAGE_WIDTH}" to img tag`,autoFixAvailable:!0,category:"structure"}),(!u.style||!u.style.includes("display:block"))&&s.push({rule:"table-attributes",severity:"error",message:'Image must have style="display:block"',line:n.line,column:n.column,suggestion:'Add style="display:block" to img tag',autoFixAvailable:!0,category:"structure"})})}catch{return $["table-attributes"].check(a)}return s},autofix:a=>{if(!a||typeof a!="string")return a;let e=a;try{e=e.replace(/<table([^>]*?)>/gi,(t,r)=>{let s=r;return s=s.replace(/cellpadding="[^"]*"/gi,'cellpadding="0"'),s=s.replace(/cellspacing="[^"]*"/gi,'cellspacing="0"'),s=s.replace(/border="[^"]*"/gi,'border="0"'),s.includes("cellpadding=")||(s+=' cellpadding="0"'),s.includes("cellspacing=")||(s+=' cellspacing="0"'),s.includes("border=")||(s+=' border="0"'),`<table${s}>`}),e=e.replace(/<td([^>]*?)>/gi,(t,r)=>{let s=r;return s=s.replace(/valign="(middle|bottom|baseline)"/gi,'valign="top"'),s.includes("valign=")||(s+=' valign="top"'),`<td${s}>`}),e=e.replace(/<img([^>]*?)(\s*\/?\s*)>/gi,(t,r)=>{let s=r;return s.includes("width=")||(s+=` width="${T.DEFAULT_IMAGE_WIDTH}"`),s.includes("height=")||(s+=` height="${T.DEFAULT_IMAGE_HEIGHT}"`),s.includes("width: 100%")&&!s.includes("max-width:")&&(s=s.replace(/style="([^"]*?)width:\s*100%([^"]*?)"/gi,(l,o,n)=>{const u=o.trim(),c=n.trim(),m=u&&!u.endsWith(";")?"; ":"",E=c&&!c.startsWith(";")?"; ":"";return`style="${u}${m}max-width:100%${E}${c}"`})),s.includes("style=")?s.includes("display:block")||(s=s.replace(/style="([^"]*?)"/gi,(l,o)=>{const n=o.trim(),u=n&&!n.endsWith(";")?"; ":"";return`style="${n}${u}display:block"`})):s+=' style="display:block"',`<img${s} />`})}catch{}return e}},"email-safe-links":{name:"email-safe-links",displayName:"Email-Safe Links",description:"Ensures links are formatted correctly for email clients",severity:"error",enabled:!0,configurable:!1,category:"structure",check:a=>{const e=[];if(!a||typeof a!="string")return e;try{const t=/<a[^>]*href\s*=\s*["']?\s*["']?[^>]*>/gi;for(const o of a.matchAll(t))(o[0].includes('href=""')||o[0].includes("href=''"))&&e.push({rule:"email-safe-links",severity:"error",message:"Link has empty href attribute",suggestion:"Remove empty links or provide valid href",autoFixAvailable:!0,category:"structure"});const r=/<a[^>]*target\s*=\s*["'](_self|_parent|_top)["'][^>]*>/gi;for(const o of a.matchAll(r))e.push({rule:"email-safe-links",severity:"warning",message:`Link target "${o[1]}" doesn't work in most email clients`,suggestion:'Use target="_blank" for all email links',autoFixAvailable:!0,category:"compatibility"});const s=/<a[^>]*href\s*=\s*["'][^"']*["'][^>]*(?!target\s*=)[^>]*>/gi;for(const o of a.matchAll(s))o[0].includes("target=")||e.push({rule:"email-safe-links",severity:"warning",message:'Link should have target="_blank" in emails',suggestion:'Add target="_blank" to all email links',autoFixAvailable:!0,category:"best-practice"});const l=/<a[^>]*href\s*=\s*["'][^"']*["'][^>]*(?!style\s*=)[^>]*>/gi;for(const o of a.matchAll(l))o[0].includes("style=")||e.push({rule:"email-safe-links",severity:"warning",message:"Link should have inline styles for email compatibility",suggestion:'Add style="color:#0000ff; text-decoration:none;" to links',autoFixAvailable:!0,category:"best-practice"})}catch{}return e},autofix:a=>{if(!a||typeof a!="string")return a;let e=a;try{e=e.replace(/<a\b([^>]*?)href\s*=\s*["']?\s*["']?([^>]*?)>/gi,(t,r,s)=>t.includes('href=""')||t.includes("href=''")||t.includes("href= ")?`<a${r} href="${qe.DEFAULT_HREF_VALUE}"${s}>`:t),e=e.replace(/<a\b([^>]*?)target\s*=\s*["'](_self|_parent|_top)["']([^>]*?)>/gi,'<a$1target="_blank"$3>'),e=e.replace(/<a\b([^>]*)>/gi,(t,r)=>{let s=r;return s=s.replace(/\s+href\s+([^"\s>]+)/gi,' href="$1"'),s=s.replace(/\s+href\s+"([^"]*)"([^>]*)/gi,' href="$1"$2'),s.includes("href=")||(s+=` href="${qe.DEFAULT_HREF_VALUE}"`),s.includes("target=")||(s+=' target="_blank"'),s.includes("style=")?s.includes("text-decoration:")||(s=s.replace(/style="([^"]*?)"/gi,(l,o)=>{const n=o.trim(),u=n&&!n.endsWith(";")?"; ":"";return`style="${n}${u}text-decoration:none"`})):s+=' style="color:#0000ff; text-decoration:none;"',`<a${s}>`})}catch{}return e}},"email-unsafe-attributes":{name:"email-unsafe-attributes",displayName:"Email-Unsafe Attributes",description:"Removes attributes that don't work or are dangerous in emails",severity:"warning",enabled:!0,configurable:!1,category:"compatibility",check:a=>{const e=[];if(!a||typeof a!="string")return e;try{["id","class","onclick","onload","onmouseover","contenteditable","draggable","data-\\w+"].forEach(r=>{g.get(`\\s${r}\\s*=\\s*["'][^"']*["']`).test(a)&&e.push({rule:"email-unsafe-attributes",severity:"warning",message:`Attribute "${r}" may not work in email clients`,suggestion:"Remove or replace with inline styles",autoFixAvailable:!0,category:"compatibility"})})}catch{}return e},autofix:a=>{if(!a||typeof a!="string")return a;try{const e=new Ce;return["id","class","onclick","onload","onmouseover","onmouseout","onfocus","onblur","contenteditable","draggable","spellcheck","tabindex","accesskey","data-[\\w-]+","aria-[\\w-]+"].forEach(r=>{e.add(g.get(`\\s${r}\\s*=\\s*["'][^"']*["']`),"")}),e.add(g.get("\\s+>","g"),">").add(g.get("\\s{2,}","g")," "),e.execute(a)}catch{return a}}},"heading-tags":{name:"heading-tags",displayName:"Heading Tags Replacement",description:"Replaces h1-h6 tags with styled spans for email compatibility",severity:"error",enabled:!0,configurable:!1,category:"structure",check:a=>{const e=[];if(!k.isValidHtml(a))return e;try{for(let t=1;t<=R.MAX_HEADING_LEVELS;t++){const r=H.TAG_OPENING(`h${t}`);k.findPatternMatches(a,r).forEach(()=>{e.push(k.createValidationResult("heading-tags","error",`Heading tag h${t} is not email-safe`,`Replace h${t} with styled span`,"structure"))})}}catch{}return e},checkWithAST:(a,e)=>{const t=[];if(!k.isValidHtml(a)||!e)return t;try{const r=["h1","h2","h3","h4","h5","h6"];k.checkForbiddenTagsAST(e,r,"heading-tags",s=>{t.push(k.createValidationResult("heading-tags","error",`Heading tag ${s.tagName} is not email-safe`,`Replace ${s.tagName} with styled span`,"structure",s.line,s.column))})}catch{return $["heading-tags"].check(a)}return t},autofix:a=>{if(!k.isValidHtml(a))return a;try{const e=Object.fromEntries(Object.entries(Xt).map(([t,r])=>[t,{fontSize:r,fontWeight:"bold"}]));return Wt.replaceTagsWithSpans(a,e)}catch{return a}}},"paragraph-tags":{name:"paragraph-tags",displayName:"Paragraph Tags Replacement",description:"Replaces p tags with spans for email compatibility",severity:"error",enabled:!0,configurable:!1,category:"structure",check:a=>{const e=[];if(!k.isValidHtml(a))return e;try{const t=H.TAG_OPENING("p");k.findPatternMatches(a,t).forEach(()=>{e.push(k.createValidationResult("paragraph-tags","error","Paragraph tag is not email-safe","Replace p with span","structure"))})}catch{}return e},checkWithAST:(a,e)=>{const t=[];if(!a||typeof a!="string"||!e)return t;try{q(e,r=>{r.type==="element"&&r.tagName==="p"&&t.push({rule:"paragraph-tags",severity:"error",message:"Paragraph tag is not email-safe",line:r.line,column:r.column,suggestion:"Replace p with span",autoFixAvailable:!0,category:"structure"})})}catch{return $["paragraph-tags"].check(a)}return t},autofix:a=>{if(!a||typeof a!="string")return a;let e=a;try{e=e.replace(g.get("<p([^>]*)>"),"<span$1>"),e=e.replace(g.get("</p>"),"</span>")}catch{}return e}},"block-element-tags":{name:"block-element-tags",displayName:"Block Element Tags Replacement",description:"Replaces block elements (div, section, etc.) with table structure for email compatibility",severity:"error",enabled:!0,configurable:!0,category:"structure",config:{blockTags:["div","section","article","nav","header","footer","main","aside","figure","figcaption"]},check:(a,e={})=>{const t=[];if(!a||typeof a!="string")return t;try{const r=e.blockTags||["div","section","article","nav","header","footer","main","aside","figure","figcaption"];Array.isArray(r)&&r.forEach(s=>{const l=g.get(`<${s}(?:\\s[^>]*)?>`,"gi"),o=a.match(l);o&&o.forEach(()=>{t.push({rule:"block-element-tags",severity:"error",message:`Block element "${s}" is not email-safe`,suggestion:`Replace ${s} with table structure`,autoFixAvailable:!0,category:"structure"})})})}catch{}return t},checkWithAST:(a,e,t={})=>{const r=[];if(!a||typeof a!="string"||!e)return r;try{const s=t.blockTags||["div","section","article","nav","header","footer","main","aside","figure","figcaption"];q(e,l=>{l.type==="element"&&l.tagName&&Array.isArray(s)&&s.includes(l.tagName)&&r.push({rule:"block-element-tags",severity:"error",message:`Block element "${l.tagName}" is not email-safe`,line:l.line,column:l.column,suggestion:`Replace ${l.tagName} with table structure`,autoFixAvailable:!0,category:"structure"})})}catch{return $["block-element-tags"].check(a,t)}return r},autofix:(a,e={})=>{if(!a||typeof a!="string")return a;let t=a;try{const r=e.blockTags||["div","section","article","nav","header","footer","main","aside","figure","figcaption"];if(Array.isArray(r)){const s=(t.match(/<table/g)||[]).length,l=T.MAX_TABLES;s<l&&r.forEach(o=>{const n=g.get(`<${o}([^>]*)>`),u=g.get(`</${o}>`);t=t.replace(n,'<table cellpadding="0" cellspacing="0" border="0"$1><tr><td valign="top">'),t=t.replace(u,"</td></tr></table>")})}}catch{}return t}},"dangerous-tags":{name:"dangerous-tags",displayName:"Dangerous Tags Removal",description:"Removes dangerous/unsupported tags (script, style, form, etc.) completely",severity:"error",enabled:!0,configurable:!0,category:"structure",config:{dangerousTags:["script","style","form","input","button","textarea","select","option","fieldset","legend","label","video","audio","canvas","svg","iframe","embed","object","base","col","area"]},check:(a,e={})=>{const t=[];if(!a||typeof a!="string")return t;try{const r=e.dangerousTags||["script","style","form","input","button","textarea","select","option","fieldset","legend","label","video","audio","canvas","svg","iframe","embed","object","base","col","area"];Array.isArray(r)&&r.forEach(s=>{const l=g.get(`<${s}(?:\\s[^>]*)?>`,"gi"),o=a.match(l);o&&o.forEach(()=>{t.push({rule:"dangerous-tags",severity:"error",message:`Dangerous tag "${s}" should be removed`,suggestion:`Remove ${s} tag completely`,autoFixAvailable:!0,category:"structure"})})})}catch{}return t},checkWithAST:(a,e,t={})=>{const r=[];if(!a||typeof a!="string"||!e)return r;try{const s=t.dangerousTags||["script","style","form","input","button","textarea","select","option","fieldset","legend","label","video","audio","canvas","svg","iframe","embed","object","base","col","area"];q(e,l=>{l.type==="element"&&l.tagName&&Array.isArray(s)&&s.includes(l.tagName)&&r.push({rule:"dangerous-tags",severity:"error",message:`Dangerous tag "${l.tagName}" should be removed`,line:l.line,column:l.column,suggestion:`Remove ${l.tagName} tag completely`,autoFixAvailable:!0,category:"structure"})})}catch{return $["dangerous-tags"].check(a,t)}return r},autofix:(a,e={})=>{if(!a||typeof a!="string")return a;let t=a;try{const r=e.dangerousTags||["script","style","form","input","button","textarea","select","option","fieldset","legend","label","video","audio","canvas","svg","iframe","embed","object","base","col","area"];Array.isArray(r)&&r.forEach(s=>{const l=g.get(`<${s}(?:\\s[^>]*)?>(?:[\\s\\S]*?)</${s}>`,"gi");t=t.replace(l,"");const o=g.get(`<${s}(?:\\s[^>]*)?/>`,"gi");t=t.replace(o,"")})}catch{}return t}},"duplicate-styles":{name:"duplicate-styles",displayName:"Duplicate Style Attributes Cleanup",description:"Merges duplicate style attributes in HTML elements",severity:"warning",enabled:!0,configurable:!1,category:"best-practice",check:a=>{const e=[];if(!a||typeof a!="string")return e;try{g.get('style="([^"]*?)"([^>]*?)style="([^"]*?)"').test(a)&&e.push({rule:"duplicate-styles",severity:"warning",message:"Duplicate style attributes found",suggestion:"Merge duplicate style attributes",autoFixAvailable:!0,category:"best-practice"})}catch{}return e},autofix:a=>{if(!a||typeof a!="string")return a;let e=a;try{for(let t=0;t<T.MAX_STYLE_MERGE_ITERATIONS;t++){const r=e;if(e=e.replace(g.get('style="([^"]*?)"([^>]*?)style="([^"]*?)"'),(s,l,o,n)=>{var I;const u=l.split(";").filter(_=>_.trim()),c=n.split(";").filter(_=>_.trim()),m=[...u,...c],E=[],f=new Set;for(const _ of m.reverse()){const L=(I=_.split(":")[0])==null?void 0:I.trim();L&&!f.has(L)&&(f.add(L),E.unshift(_.trim()))}return`style="${E.join("; ")}"${o}`}),r===e)break}}catch{}return e}},"table-nesting-cleanup":{name:"table-nesting-cleanup",displayName:"Table Nesting Cleanup",description:"Reduces excessive table nesting for better email rendering",severity:"warning",enabled:!0,configurable:!0,category:"structure",config:{maxIterations:T.MAX_AUTOFIX_ITERATIONS},check:a=>{const e=[];if(!a||typeof a!="string")return e;try{g.get("<table([^>]*?)><tr><td([^>]*?)><table([^>]*?)><tr><td([^>]*?)>").test(a)&&e.push({rule:"table-nesting-cleanup",severity:"warning",message:"Excessive table nesting detected",suggestion:"Reduce table nesting for better email compatibility",autoFixAvailable:!0,category:"structure"})}catch{}return e},autofix:(a,e={})=>{if(!a||typeof a!="string")return a;let t=a;try{const r=typeof e.maxIterations=="number"?e.maxIterations:T.MAX_AUTOFIX_ITERATIONS;for(let s=0;s<r;s++){const l=t;if(t=t.replace(g.get("<table([^>]*?)><tr><td([^>]*?)><table([^>]*?)><tr><td([^>]*?)>"),"<table$1><tr><td$2>"),t=t.replace(g.get("<\\/td><\\/tr><\\/table><\\/td><\\/tr><\\/table>"),"</td></tr></table>"),l===t)break}t=t.replace(g.get("<table[^>]*><tr><td[^>]*>\\s*<\\/td><\\/tr><\\/table>"),""),t=t.replace(g.get("<table[^>]*><tr><td[^>]*>(\\s*<span[^>]*>[^<]+<\\/span>\\s*)<\\/td><\\/tr><\\/table>"),"$1")}catch{}return t}},"empty-elements-cleanup":{name:"empty-elements-cleanup",displayName:"Empty Elements Cleanup",description:"Removes empty and whitespace-only elements",severity:"info",enabled:!0,configurable:!1,category:"best-practice",check:a=>{const e=[];if(!a||typeof a!="string")return e;try{g.get("<span[^>]*>\\s*<\\/span>").test(a)&&e.push({rule:"empty-elements-cleanup",severity:"info",message:"Empty elements found",suggestion:"Remove empty and whitespace-only elements",autoFixAvailable:!0,category:"best-practice"})}catch{}return e},autofix:a=>{if(!a||typeof a!="string")return a;let e=a;try{e=e.replace(g.get("<span[^>]*>\\s*<\\/span>"),""),e=e.replace(g.get("<span[^>]*>[\\s\\t\\n\\r]*<\\/span>"),"")}catch{}return e}},"malformed-attributes":{name:"malformed-attributes",displayName:"Malformed Attributes Fix",description:'Fixes malformed attributes like "s rc" to "src"',severity:"error",enabled:!0,configurable:!1,category:"structure",check:a=>{const e=[];if(!a||typeof a!="string")return e;try{g.get("\\bs\\s+rc=").test(a)&&e.push({rule:"malformed-attributes",severity:"error",message:'Malformed "s rc" attribute found',suggestion:'Fix "s rc" to "src"',autoFixAvailable:!0,category:"structure"}),g.get('="([^"]*)"([a-zA-Z]+=)').test(a)&&e.push({rule:"malformed-attributes",severity:"error",message:"Missing spaces between attributes",suggestion:"Add spaces between attributes",autoFixAvailable:!0,category:"structure"})}catch{}return e},autofix:a=>{if(!a||typeof a!="string")return a;let e=a;try{const t=new Ce;t.add(g.get("\\bs\\s+rc="),"src=").add(g.get("\\bS\\s+RC="),"src=").add(g.get('="([^"]*)"([a-zA-Z]+=)'),'="$1" $2').add(g.get('(<img[^>]*?)([a-zA-Z0-9_.-]+")([a-zA-Z]+=)'),"$1$2 $3"),e=t.execute(e)}catch{}return e}},"image-alt-attributes":{name:"image-alt-attributes",displayName:"Image Alt Attributes",description:"Ensures all images have meaningful alt attributes for accessibility",severity:"warning",enabled:!0,configurable:!1,category:"accessibility",check:a=>{const e=[],t=a.match(/<img(?![^>]*\salt\s*=\s*["'][^"']+["'])[^>]*>/gi);t&&t.forEach(()=>{e.push({rule:"image-alt-attributes",severity:"error",message:"Image missing meaningful alt attribute for accessibility",line:0,column:0})});const r=a.match(/<img[^>]*alt\s*=\s*["']?\s*["'][^>]*>/gi);return r&&r.forEach(()=>{e.push({rule:"image-alt-attributes",severity:"warning",message:"Image has empty alt attribute - should be descriptive",line:0,column:0})}),e},autofix:a=>{if(!a||typeof a!="string")return a;let e=a;try{e=e.replace(/<img([^>]*?)(\s*\/?\s*)>/gi,(t,r)=>{var n;let s=r;const l=r.match(/src\s*=\s*["']([^"']+)["']/i);let o=T.DEFAULT_ALT_TEXT;if(l){const u=(n=l[1].split("/").pop())==null?void 0:n.split(".")[0];u&&(o=u.replace(/[_-]/g," ").replace(/\b\w/g,c=>c.toUpperCase()))}return s=s.replace(/\s*alt\s*=\s*["'][^"']*["']/gi,""),s+=` alt="${o}"`,`<img${s} />`})}catch{}return e}}};function Ie(a){return{div:"Use <table><tr><td>content</td></tr></table>",p:"Use <span>content</span>",h1:`Use <span style="font-weight:bold; font-size:${T.HEADING_FONT_SIZES.h1}px;">content</span>`,h2:`Use <span style="font-weight:bold; font-size:${T.HEADING_FONT_SIZES.h2}px;">content</span>`,h3:`Use <span style="font-weight:bold; font-size:${T.HEADING_FONT_SIZES.h3}px;">content</span>`,h4:`Use <span style="font-weight:bold; font-size:${T.HEADING_FONT_SIZES.h4}px;">content</span>`,h5:`Use <span style="font-weight:bold; font-size:${T.HEADING_FONT_SIZES.h5}px;">content</span>`,h6:`Use <span style="font-weight:bold; font-size:${T.HEADING_FONT_SIZES.h6}px;">content</span>`,section:"Use <table><tr><td>content</td></tr></table>",article:"Use <table><tr><td>content</td></tr></table>",nav:"Use <table><tr><td>content</td></tr></table>",header:"Use <table><tr><td>content</td></tr></table>",footer:"Use <table><tr><td>content</td></tr></table>",main:"Use <table><tr><td>content</td></tr></table>",aside:"Use <table><tr><td>content</td></tr></table>",figure:"Use <table><tr><td>content</td></tr></table>",figcaption:"Use <table><tr><td>content</td></tr></table>",script:"Remove - not supported in emails",style:"Use inline styles instead",form:"Remove - forms not supported in emails",input:"Remove - interactive elements not supported",button:"Use <a> link styled as button",textarea:"Remove - not supported in emails",select:"Remove - not supported in emails",option:"Remove - not supported in emails",fieldset:"Remove - not supported in emails",legend:"Remove - not supported in emails",label:"Remove - not supported in emails",video:"Use static image or GIF instead",audio:"Remove - not supported in emails",canvas:"Use static image instead",svg:"Use PNG/JPG image instead",iframe:"Remove - not supported in emails",embed:"Remove - not supported in emails",object:"Remove - not supported in emails"}[a]||"Replace with email-safe alternative"}function Zt(a){return T.HEADING_FONT_SIZES[`h${a}`]||16}class Qe{constructor(e){A(this,"config");A(this,"customRules",new Map);A(this,"fixHistory",new Map);A(this,"maxFixHistorySize",R.MAX_FIX_HISTORY_SIZE);A(this,"cleanupTimer");this.config=e,this.startCleanupTimer()}startCleanupTimer(){this.cleanupTimer&&clearTimeout(this.cleanupTimer),this.cleanupTimer=setTimeout(()=>{this.performCleanup(),this.startCleanupTimer()},zt.TEN_MINUTES_MS)}performCleanup(){const e=Date.now(),t=R.MAX_FIX_HISTORY_AGE_MS;let r=0;for(const[s,l]of this.fixHistory.entries())e-l.timestamp>t&&(this.fixHistory.delete(s),r++);if(this.fixHistory.size>this.maxFixHistorySize){const s=Array.from(this.fixHistory.entries()).sort((o,n)=>o[1].timestamp-n[1].timestamp),l=Math.floor(this.fixHistory.size*R.CACHE_CLEANUP_PERCENTAGE);for(let o=0;o<l&&o<s.length;o++)this.fixHistory.delete(s[o][0]),r++}r>0&&h.debug("AutofixEngine",`Cleanup completed. Cleared ${r} history entries`,{cleared:r})}autoFix(e){if(!e||typeof e!="string")return{html:"",fixed:[]};if(e.length>this.config.maxHtmlSize){const o=Math.round(this.config.maxHtmlSize/1024),n=Math.round(e.length/1024);return h.warn("AutofixEngine",`${w.HTML_TOO_LARGE_FOR_AUTOFIX} (${n}KB > ${o}KB), skipping to prevent freezing`,{size:e.length,limit:this.config.maxHtmlSize}),{html:e,fixed:[]}}let t=e;const r=[],s=R.MAX_AUTOFIX_PASSES;let l=0;try{const o=["dangerous-tags","heading-tags","paragraph-tags","block-element-tags","email-safe-tags","malformed-attributes","email-safe-links","image-alt-attributes","table-attributes","email-unsafe-attributes","duplicate-styles","table-nesting-cleanup","empty-elements-cleanup"];for(let n=0;n<s;n++){let u=0;const c=t;for(const f of o){const{html:v,fixed:I}=this.applySingleFix(t,f);if(I&&(t=v,r.includes(f)||r.push(f),u++,l++,t.length>e.length*R.MAX_HTML_SIZE_INCREASE_MULTIPLIER)){h.warn("AutofixEngine",`HTML size increased too much during autofix, stopping pass ${n+1}`,{originalSize:e.length,newSize:t.length,pass:n+1});break}}const m=this.applyRemainingFixes(t,o,r,R.MAX_AUTOFIX_ITERATIONS);m.iterations>0&&(t=m.html,u+=m.iterations,l+=m.iterations);const E=this.applyCustomFixes(t,r,R.MAX_AUTOFIX_ITERATIONS);if(E.iterations>0&&(t=E.html,u+=E.iterations,l+=E.iterations),h.debug("AutofixEngine",`Pass ${n+1}: Applied ${u} fixes`,{pass:n+1,changes:u}),u===0||t===c){h.debug("AutofixEngine",`No more changes after pass ${n+1}, stopping`,{totalPasses:n+1});break}}return this.recordFixHistory(e,r,l,!0),r.length>0?h.debug("AutofixEngine",`Auto-fix completed with ${l} total changes. Fixed ${r.length} rule types: ${r.join(", ")}`,{totalChanges:l,fixedRules:r}):h.debug("AutofixEngine","No auto-fixes were applied"),{html:t,fixed:r}}catch(o){return h.error("AutofixEngine","Critical auto-fix error",o),this.recordFixHistory(e,r,l,!1),{html:e,fixed:[]}}}applySingleFix(e,t){const r=$[t],s=this.config.rules[t];if(!(s?s.enabled:r.enabled)||!r.autofix)return{html:e,fixed:!1};try{const o=e,n=r.autofix(e);return o!==n?this.isValidHTMLStructure(n)?{html:n,fixed:!0}:(h.warn("AutofixEngine",`Fix for rule ${t} produced invalid HTML, reverting`),{html:e,fixed:!1}):{html:e,fixed:!1}}catch(o){return h.error("AutofixEngine",`Error applying auto-fix for rule ${t}`,o),{html:e,fixed:!1}}}applyRemainingFixes(e,t,r,s){let l=e,o=0;const n=[];for(const[m,E]of Object.entries($))if(!t.includes(m)&&E.autofix){const f=this.config.rules[m];(f?f.enabled:E.enabled)&&n.push(m)}let u=!0,c=0;for(;u&&c<3&&o<s;){u=!1,c++;for(const m of n){if(o>=s)break;try{const E=l,{html:f,fixed:v}=this.applySingleFix(l,m);v&&E!==f&&(l=f,r.includes(m)||r.push(m),o++,u=!0,h.debug("AutofixEngine",`Applied remaining auto-fix for rule: ${m} (pass ${c})`,{pass:c,rule:m}))}catch(E){h.error("AutofixEngine",`Error applying remaining auto-fix for rule ${m}`,E)}}u&&h.debug("AutofixEngine",`Remaining fixes pass ${c} completed with changes`,{pass:c,iterations:o})}return{html:l,iterations:o}}applyCustomFixes(e,t,r){let s=e,l=0;for(const[o,n]of this.customRules.entries()){if(l>=r)break;const u=this.config.rules[o];if(!(!(!u||u.enabled)||!n.autofix))try{const{html:m,fixed:E}=this.applySingleFix(s,o);E&&(s=m,t.push(o),l++,h.debug("AutofixEngine",`Applied custom auto-fix for rule: ${o}`))}catch(m){h.error("AutofixEngine",`Error applying custom auto-fix for rule ${o}`,m)}}return{html:s,iterations:l}}isValidHTMLStructure(e){if(!e||typeof e!="string")return!1;try{const t=(e.match(/<[^/][^>]*>/g)||[]).length,r=(e.match(/<\/[^>]*>/g)||[]).length,s=(e.match(/<[^>]*\/>/g)||[]).length;return t+r+s===0?!0:!(e.includes("<<")||e.includes(">>")||e.includes("<//")||e.includes("//>"))}catch{return!1}}recordFixHistory(e,t,r,s){const l=`${e.length}_${t.join("_")}`;if(this.fixHistory.set(l,{timestamp:Date.now(),iterations:r,success:s}),this.fixHistory.size>this.maxFixHistorySize){const o=Array.from(this.fixHistory.entries()).sort((u,c)=>u[1].timestamp-c[1].timestamp),n=Math.floor(this.fixHistory.size*R.CACHE_CLEANUP_PERCENTAGE_REDUCED);for(let u=0;u<n&&u<o.length;u++)this.fixHistory.delete(o[u][0])}}autoFixSpecificIssue(e,t){if(!e||typeof e!="string"||!t)return{html:e,fixed:!1};try{const r=$[t]||this.customRules.get(t);if(!r)return h.warn("AutofixEngine",`Rule ${t} not found`),{html:e,fixed:!1};if(!r.autofix)return h.warn("AutofixEngine",`Rule ${t} has no autofix function`),{html:e,fixed:!1};const s=this.config.rules[t];if(!(s?s.enabled:r.enabled))return h.warn("AutofixEngine",`Rule ${t} is disabled`),{html:e,fixed:!1};let o=e,n=!1,u=0;const c=10;for(;u<c;){const m=o;try{const E=r.autofix(o);if(m!==E&&this.isValidHTMLStructure(E))o=E,n=!0,u++,h.debug("AutofixEngine",`Applied fix for rule ${t}, iteration ${u}`,{iteration:u,changed:!0});else break}catch(E){h.error("AutofixEngine",`Error in iteration ${u+1} for rule ${t}`,E);break}if(o.length>e.length*R.MAX_HTML_SIZE_INCREASE_MULTIPLIER){h.warn("AutofixEngine",`HTML size increased too much for rule ${t}, stopping`,{originalSize:e.length,newSize:o.length});break}}return n?(h.debug("AutofixEngine",`Successfully fixed issue with rule ${t} in ${u} iterations`,{iterations:u,sizeBefore:e.length,sizeAfter:o.length}),{html:o,fixed:!0}):(h.debug("AutofixEngine",`No changes made for rule ${t}`),{html:e,fixed:!1})}catch(r){return h.error("AutofixEngine",`Error applying auto-fix for rule ${t}`,r),{html:e,fixed:!1}}}autoFixMultipleIssues(e,t){if(!e||typeof e!="string"||!Array.isArray(t))return{html:e,fixed:[]};let r=e;const s=[],l=3;try{for(let o=0;o<l;o++){let n=!1;const u=r;for(const c of t){const{html:m,fixed:E}=this.autoFixSpecificIssue(r,c);E&&(r=m,s.includes(c)||s.push(c),n=!0)}if(h.debug("AutofixEngine",`Multiple fixes pass ${o+1}: ${n?"changes made":"no changes"}`,{pass:o+1,hasChanges:n}),!n||r===u)break}return h.debug("AutofixEngine",`Multiple auto-fixes completed. Fixed ${s.length} rule types: ${s.join(", ")}`,{fixedCount:s.length,rules:s}),{html:r,fixed:s}}catch(o){return h.error("AutofixEngine","Error applying multiple auto-fixes",o),{html:e,fixed:[]}}}autoFixAllIssues(e,t){if(!e||typeof e!="string")return{html:e,fixed:[]};try{const r=this.getRulesBySeverity(t);return r.length===0?{html:e,fixed:[]}:this.autoFixMultipleIssues(e,r)}catch(r){return h.error("AutofixEngine",`Error fixing all ${t} issues`,r),{html:e,fixed:[]}}}autoFixCategory(e,t){if(!e||typeof e!="string"||!t)return{html:e,fixed:[]};try{const r=this.getRulesByCategory(t);return r.length===0?{html:e,fixed:[]}:this.autoFixMultipleIssues(e,r)}catch(r){return h.error("AutofixEngine",`Error fixing all ${t} issues`,r),{html:e,fixed:[]}}}getAutoFixableRules(){const e=[];return Object.entries($).forEach(([t,r])=>{const s=this.config.rules[t],l=s?s.enabled:r.enabled;r.autofix&&l&&e.push(t)}),this.customRules.forEach((t,r)=>{const s=this.config.rules[r],l=s?s.enabled:!0;t.autofix&&l&&e.push(r)}),e}getRulesByCategory(e){const t=[];return Object.entries($).forEach(([r,s])=>{const l=this.config.rules[r],o=l?l.enabled:s.enabled;s.category===e&&o&&t.push(r)}),this.customRules.forEach((r,s)=>{const l=this.config.rules[s],o=l?l.enabled:!0;r.category===e&&o&&t.push(s)}),t}getRulesBySeverity(e){const t=[];return Object.entries($).forEach(([r,s])=>{const l=this.config.rules[r],o=l?l.enabled:s.enabled;s.severity===e&&o&&t.push(r)}),this.customRules.forEach((r,s)=>{const l=this.config.rules[s],o=l?l.enabled:!0;r.severity===e&&o&&t.push(s)}),t}addRule(e){if(!e||!e.name){h.warn("AutofixEngine","Invalid validation rule provided",e);return}this.customRules.set(e.name,e)}removeRule(e){if(!e){h.warn("AutofixEngine","Invalid rule name provided for removal",e);return}this.customRules.delete(e)}getConfig(){return{...this.config}}updateConfig(e){if(!e){h.warn("AutofixEngine","Invalid config provided for update",e);return}this.config={...this.config,...e,rules:{...this.config.rules,...e.rules},targetClients:{...this.config.targetClients,...e.targetClients}}}setRuleEnabled(e,t){if(!e){h.warn("AutofixEngine","Invalid rule name provided for enable/disable",e);return}this.config.rules[e]?this.config.rules[e].enabled=t:this.config.rules[e]={enabled:t}}setRuleSeverity(e,t){if(!e||!t){h.warn("AutofixEngine","Invalid rule name or severity provided",{ruleName:e,severity:t});return}this.config.rules[e]?this.config.rules[e].severity=t:this.config.rules[e]={enabled:!0,severity:t}}getFixHistoryStats(){const e=Array.from(this.fixHistory.values()),t=e.length,r=e.filter(n=>n.success).length,s=e.reduce((n,u)=>n+u.iterations,0)/t||0,l=e.sort((n,u)=>u.timestamp-n.timestamp).slice(0,R.MAX_RECENT_FIXES_TRACKED),o=l.length>0?l.filter(n=>n.success).length/l.length:0;return{totalFixes:t,successfulFixes:r,averageIterations:Math.round(s*100)/100,recentSuccessRate:Math.round(o*100)/100}}dispose(){this.customRules.clear(),this.fixHistory.clear(),this.cleanupTimer&&(clearTimeout(this.cleanupTimer),this.cleanupTimer=void 0),h.debug("AutofixEngine","Disposed and all caches cleared")}}class Je{constructor(e){A(this,"config");A(this,"customRules",new Map);A(this,"traversalCache",new Map);A(this,"maxTraversalCacheSize",T.TRAVERSAL_CACHE_SIZE);A(this,"cacheCleanupTimer");A(this,"cacheAccessCount",new Map);A(this,"cacheLastAccess",new Map);this.config=e,this.startCacheCleanupTimer()}startCacheCleanupTimer(){this.cacheCleanupTimer&&clearTimeout(this.cacheCleanupTimer),this.cacheCleanupTimer=setTimeout(()=>{this.performCacheCleanup(),this.startCacheCleanupTimer()},T.CACHE_CLEANUP_INTERVAL_MS)}performCacheCleanup(){const e=Date.now();let t=0;for(const[r]of this.traversalCache.entries()){const s=`traversal_${r}`,l=this.cacheLastAccess.get(s)||0,o=this.cacheAccessCount.get(s)||0;(e-l>T.CACHE_TTL_MS||o<2)&&(this.traversalCache.delete(r),this.cacheAccessCount.delete(s),this.cacheLastAccess.delete(s),t++)}if(this.customRules.size>R.MAX_CUSTOM_RULES_SIZE){const r=Array.from(this.customRules.entries()),s=Math.floor(this.customRules.size*R.CACHE_CLEANUP_PERCENTAGE_REDUCED);for(let l=0;l<s&&l<r.length;l++)this.customRules.delete(r[l][0]);t+=s}t>0&&h.debug("ValidationEngine",`Cache cleanup completed. Cleared ${t} entries`,{totalCleared:t})}getParsedAST(e){if(!e||typeof e!="string")return null;try{let t=Q.get(e);return t||(t=new Re(e).parse(),Q.set(e,t)),t}catch(t){return h.error("ValidationEngine","Error parsing HTML to AST",t),null}}getTraversalResult(e,t,r){const s=`traversal_${t}`;this.traversalCache.has(t)||this.traversalCache.set(t,new Map);const l=this.traversalCache.get(t);if(l.has(r))return this.cacheAccessCount.set(s,(this.cacheAccessCount.get(s)||0)+1),this.cacheLastAccess.set(s,Date.now()),l.get(r);let o=[];try{switch(t){case"findByTag":o=this.findNodesByTagName(e,r);break;case"findByAttribute":{const[n,u]=r.split("=");o=this.findNodesByAttribute(e,n,u);break}case"findByCategory":o=this.findNodesByCategory(e,r);break;default:o=[]}o.length<=R.MAX_TRAVERSAL_RESULTS&&(l.set(r,o),this.cacheAccessCount.set(s,1),this.cacheLastAccess.set(s,Date.now()),l.size>this.maxTraversalCacheSize&&this.cleanupOperationCache(t,l))}catch(n){h.error("ValidationEngine",`Error in traversal operation ${t}`,n),o=[]}return o}cleanupOperationCache(e,t){const r=Array.from(t.entries()).map(([l,o])=>({key:l,nodes:o,accessCount:this.cacheAccessCount.get(`traversal_${e}`)||0,lastAccess:this.cacheLastAccess.get(`traversal_${e}`)||0,size:o.length}));r.sort((l,o)=>{const n=l.accessCount*O.TRAVERSAL_ACCESS_COUNT_WEIGHT+(Date.now()-l.lastAccess)/1e3*O.TRAVERSAL_AGE_WEIGHT+l.size/100*O.TRAVERSAL_SIZE_WEIGHT,u=o.accessCount*O.TRAVERSAL_ACCESS_COUNT_WEIGHT+(Date.now()-o.lastAccess)/1e3*O.TRAVERSAL_AGE_WEIGHT+o.size/100*O.TRAVERSAL_SIZE_WEIGHT;return n-u});const s=Math.floor(t.size*R.CACHE_CLEANUP_PERCENTAGE_LARGE);for(let l=0;l<s&&l<r.length;l++)t.delete(r[l].key)}findNodesByTagName(e,t){const r=[],s=R.MAX_TRAVERSAL_RESULTS,l=o=>{for(const n of o){if(r.length>=s)break;n.type==="element"&&n.tagName===t.toLowerCase()&&r.push(n),n.children&&Array.isArray(n.children)&&l(n.children)}};return l(e),r}findNodesByAttribute(e,t,r){const s=[],l=R.MAX_TRAVERSAL_RESULTS,o=n=>{var u;for(const c of n){if(s.length>=l)break;c.type==="element"&&((u=c.attributes)!=null&&u[t])&&(!r||c.attributes[t]===r)&&s.push(c),c.children&&Array.isArray(c.children)&&o(c.children)}};return o(e),s}findNodesByCategory(e,t){const r=[],s=R.MAX_TRAVERSAL_RESULTS,l=o=>{for(const n of o){if(r.length>=s)break;if(n.type==="element")switch(t){case"tables":n.tagName==="table"&&r.push(n);break;case"images":n.tagName==="img"&&r.push(n);break;case"links":n.tagName==="a"&&r.push(n);break;case"headings":n.tagName&&/^h[1-6]$/.test(n.tagName)&&r.push(n);break;case"block-elements":n.tagName&&["div","p","section","article","nav","header","footer","main","aside"].includes(n.tagName)&&r.push(n);break;case"dangerous":n.tagName&&["script","style","iframe","embed","object"].includes(n.tagName)&&r.push(n);break}n.children&&Array.isArray(n.children)&&l(n.children)}};return l(e),r}clearTraversalCache(){const e=this.traversalCache.size;this.traversalCache.clear(),this.cacheAccessCount.clear(),this.cacheLastAccess.clear(),e>0&&h.debug("ValidationEngine",`Cleared traversal cache with ${e} operations`,{cacheSize:e})}validate(e){if(!e||typeof e!="string")return this.createEmptyReport("Invalid HTML input provided");if(e.length>this.config.maxHtmlSize){const s=Math.round(this.config.maxHtmlSize/1024);return this.createEmptyReport(`${w.HTML_TOO_LARGE} (over ${s}KB)`,"html-too-large","performance")}const t=[],r=this.getParsedAST(e);try{t.push(...this.runBuiltInRules(e,r)),t.push(...this.runCustomRules(e,r));const s=t.filter(c=>c.severity==="error"),l=t.filter(c=>c.severity==="warning"),o=t.filter(c=>c.severity==="info"),n=this.calculateCategories(t),u=this.calculateValidationScore(t);return{isValid:s.length===0,errors:s,warnings:l,suggestions:o,autoFixAvailable:t.some(c=>c.autoFixAvailable),totalIssues:t.length,categories:n,score:u}}catch(s){return h.error("ValidationEngine","Critical validation error",s),this.createEmptyReport(`Validation system error: ${s instanceof Error?s.message:"Unknown error"}`,"validation-system-error","structure")}finally{this.clearTraversalCache()}}runBuiltInRules(e,t){const r=[];this.clearTraversalCache();for(const[s,l]of Object.entries($)){const o=this.config.rules[s];if((o?o.enabled:l.enabled)&&!(l.category==="accessibility"&&!this.config.checkAccessibility)&&!(l.category==="performance"&&!this.config.checkPerformance)&&!(l.category==="best-practice"&&!this.config.checkBestPractices))try{let u=[];if(l.checkWithAST&&t){const c={ast:t,getTraversalResult:(m,E)=>this.getTraversalResult(t,m,E),findNodesByTag:m=>this.getTraversalResult(t,"findByTag",m),findNodesByAttribute:(m,E)=>this.getTraversalResult(t,"findByAttribute",`${m}=${E||""}`),findNodesByCategory:m=>this.getTraversalResult(t,"findByCategory",m)};u=l.checkWithAST(e,t,o==null?void 0:o.config,c)}else u=l.check(e,o==null?void 0:o.config);o!=null&&o.severity&&u.forEach(c=>{c.severity=o.severity}),r.push(...u)}catch(u){h.error("ValidationEngine",`Error running validation rule ${s}`,u),r.push({rule:s,severity:"error",message:`Validation rule error: ${u instanceof Error?u.message:"Unknown error"}`,category:l.category})}}return r}runCustomRules(e,t){const r=[];for(const[s,l]of this.customRules.entries()){const o=this.config.rules[s];if(!o||o.enabled)try{const u=l.checkWithAST&&t?l.checkWithAST(e,t,o==null?void 0:o.config):l.check(e,o==null?void 0:o.config);o!=null&&o.severity&&u.forEach(c=>{c.severity=o.severity}),r.push(...u)}catch(u){h.error("ValidationEngine",`Error running custom validation rule ${s}`,u)}}return r}calculateCategories(e){return{structure:e.filter(t=>t.category==="structure").length,accessibility:e.filter(t=>t.category==="accessibility").length,compatibility:e.filter(t=>t.category==="compatibility").length,performance:e.filter(t=>t.category==="performance").length,"best-practice":e.filter(t=>t.category==="best-practice").length}}calculateValidationScore(e){if(e.length===0)return ee.MAX_SCORE;let t=0;const r=ee.MAX_PENALTY;e.forEach(l=>{switch(l.severity){case"error":t+=ee.ERROR_PENALTY;break;case"warning":t+=ee.WARNING_PENALTY;break;case"info":t+=ee.INFO_PENALTY;break}});const s=Math.max(0,ee.MAX_SCORE-Math.min(t,r));return Math.round(s)}createEmptyReport(e,t="invalid-input",r="structure"){return{isValid:!1,errors:[{rule:t,severity:"error",message:e,category:r}],warnings:[],suggestions:[],autoFixAvailable:!1,totalIssues:1,categories:{structure:r==="structure"?1:0,accessibility:0,compatibility:0,performance:r==="performance"?1:0,"best-practice":0},score:0}}addRule(e){if(!e||!e.name){h.warn("ValidationEngine","Invalid validation rule provided",e);return}this.customRules.set(e.name,e)}removeRule(e){if(!e){h.warn("ValidationEngine","Invalid rule name provided for removal",e);return}this.customRules.delete(e)}getAvailableRules(){const e={...$};return this.customRules.forEach((t,r)=>{e[r]=t}),e}testRule(e,t){if(!e||!t)return h.warn("ValidationEngine","Invalid parameters for testRule",{ruleName:e,html:typeof t}),[];const r=$[e]||this.customRules.get(e);if(!r)throw new Error(`Rule "${e}" not found`);const s=this.config.rules[e];return r.check(t,s==null?void 0:s.config)}getCompatibilityReport(e){if(!e||typeof e!="string")return{};const t={};return Object.keys(this.config.targetClients).forEach(r=>{if(!this.config.targetClients[r])return;const s=[];switch(r){case"outlook":this.validateOutlookCompatibility(e,s);break;case"gmail":this.validateGmailCompatibility(e,s);break;case"mobile":this.validateMobileCompatibility(e,s);break}t[r]={compatible:s.length===0,issues:s}}),t}validateOutlookCompatibility(e,t){(e.includes("flexbox")||e.includes("display: flex"))&&t.push("Flexbox not supported in Outlook"),(e.includes("grid")||e.includes("display: grid"))&&t.push("CSS Grid not supported in Outlook"),(e.includes("position: absolute")||e.includes("position: fixed"))&&t.push("Absolute/fixed positioning not supported in Outlook"),(e.includes("linear-gradient")||e.includes("radial-gradient"))&&t.push("CSS gradients not supported in Outlook")}validateGmailCompatibility(e,t){e.includes("<style>")&&t.push("Gmail may strip <style> tags on mobile"),e.includes("background-image")&&t.push("Background images may not display consistently in Gmail")}validateMobileCompatibility(e,t){e.includes('width="')&&!e.includes("max-width")&&t.push("Fixed widths without max-width may cause horizontal scrolling on mobile"),e.includes("font-size:")&&e.includes("px")&&t.push("Consider using relative font sizes for better mobile experience")}getCacheStats(){return{traversalCacheSize:this.traversalCache.size,astCacheStats:Q.getStats(),regexCacheStats:g.getStats()}}dispose(){this.clearTraversalCache(),this.customRules.clear(),this.cacheCleanupTimer&&(clearTimeout(this.cacheCleanupTimer),this.cacheCleanupTimer=void 0),h.debug("ValidationEngine","Disposed and all caches cleared")}}class et{constructor(e){A(this,"config");A(this,"validationEngine");A(this,"autofixEngine");A(this,"cleanupInterval");A(this,"isDisposed",!1);A(this,"validationStats",{totalValidations:0,successfulValidations:0,totalAutoFixes:0,successfulAutoFixes:0,lastValidationTime:0,lastAutoFixTime:0});this.config={rules:{},targetClients:{outlook:!0,gmail:!0,applemail:!0,thunderbird:!0,mobile:!0},strictMode:!1,allowModernCSS:!1,maxTableNesting:T.MAX_TABLE_NESTING,checkAccessibility:!0,checkPerformance:!0,checkBestPractices:!0,maxFileSize:T.MAX_FILE_SIZE_KB,maxHtmlSize:T.MAX_HTML_SIZE_BYTES,requireAltText:!0,requireFallbacks:!0,...e},this.initializeDefaultRules(),this.validationEngine=new Je(this.config),this.autofixEngine=new Qe(this.config),this.setupCleanupInterval()}setupCleanupInterval(){try{this.cleanupInterval=setInterval(()=>{this.performPeriodicCleanup()},T.CACHE_CLEANUP_INTERVAL_MS)}catch(e){h.error("EmailHTMLValidator","Failed to setup cleanup interval",e)}}performPeriodicCleanup(){try{if(this.isDisposed)return;const e=this.validationEngine.getCacheStats(),t=this.autofixEngine.getFixHistoryStats();if(h.debug("EmailHTMLValidator",te.CACHE_CLEANUP_PREFIX,{validationCache:e,autofixHistory:t}),typeof global<"u"&&global.gc)try{global.gc(),h.debug("EmailHTMLValidator",te.GARBAGE_COLLECTION_PREFIX)}catch{}}catch(e){h.error("EmailHTMLValidator","Error during periodic cleanup",e)}}initializeDefaultRules(){Object.entries($).forEach(([t,r])=>{this.config.rules[t]||(this.config.rules[t]={enabled:r.enabled!==!1})}),["email-safe-tags","table-attributes","heading-tags","paragraph-tags","block-element-tags","dangerous-tags","email-safe-links","malformed-attributes"].forEach(t=>{$[t]&&(this.config.rules[t]={enabled:!0})})}validate(e){if(this.isDisposed)throw new Error(w.VALIDATOR_DISPOSED);const t=Date.now();this.validationStats.totalValidations++;try{if(!e||typeof e!="string")throw new Error(w.INVALID_HTML_INPUT);if(e.length>this.config.maxHtmlSize){const l=Math.round(this.config.maxHtmlSize/1024),o=Math.round(e.length/1024);throw new Error(`${w.HTML_TOO_LARGE}: ${o}KB exceeds limit of ${l}KB`)}const r=this.validationEngine.validate(e);this.validationStats.successfulValidations++,this.validationStats.lastValidationTime=Date.now();const s=Date.now()-t;return s>R.SLOW_VALIDATION_THRESHOLD_MS&&h.warn("EmailHTMLValidator",`${te.SLOW_OPERATION_PREFIX}: ${s}ms for ${e.length} bytes`,{duration:s,htmlSize:e.length,issues:r.totalIssues}),r}catch(r){this.validationStats.lastValidationTime=Date.now(),h.error("EmailHTMLValidator",w.VALIDATION_FAILED,r);const s=r instanceof Error?r.message:"Unknown validation error";return{isValid:!1,errors:[{rule:"validation-error",severity:"error",message:`${w.VALIDATION_FAILED}: ${s}`,category:"structure"}],warnings:[],suggestions:[],autoFixAvailable:!1,totalIssues:1,categories:{structure:1,accessibility:0,compatibility:0,performance:0,"best-practice":0},score:0}}}autoFix(e){if(this.isDisposed)throw new Error(w.VALIDATOR_DISPOSED);const t=Date.now();this.validationStats.totalAutoFixes++;try{if(!e||typeof e!="string")throw new Error(w.INVALID_HTML_INPUT);if(e.length>this.config.maxHtmlSize){const l=Math.round(this.config.maxHtmlSize/1024),o=Math.round(e.length/1024);throw new Error(`${w.HTML_TOO_LARGE_FOR_AUTOFIX}: ${o}KB exceeds limit of ${l}KB`)}const r=this.autofixEngine.autoFix(e);this.validationStats.successfulAutoFixes++,this.validationStats.lastAutoFixTime=Date.now();const s=Date.now()-t;return s>R.SLOW_AUTOFIX_THRESHOLD_MS&&h.warn("EmailHTMLValidator",`${te.SLOW_OPERATION_PREFIX}: ${s}ms for ${e.length} bytes`,{duration:s,htmlSize:e.length,fixedRules:r.fixed.length}),r}catch(r){return this.validationStats.lastAutoFixTime=Date.now(),h.error("EmailHTMLValidator",w.AUTOFIX_FAILED,r),{html:e,fixed:[]}}}autoFixSpecificIssue(e,t){if(this.isDisposed)throw new Error(w.VALIDATOR_DISPOSED);try{return this.autofixEngine.autoFixSpecificIssue(e,t)}catch(r){return h.error("EmailHTMLValidator",`Error fixing specific issue with rule ${t}`,r),{html:e,fixed:!1}}}autoFixMultipleIssues(e,t){if(this.isDisposed)throw new Error(w.VALIDATOR_DISPOSED);try{return this.autofixEngine.autoFixMultipleIssues(e,t)}catch(r){return h.error("EmailHTMLValidator","Error fixing multiple issues",r),{html:e,fixed:[]}}}autoFixAllIssues(e,t){if(this.isDisposed)throw new Error(w.VALIDATOR_DISPOSED);try{return this.autofixEngine.autoFixAllIssues(e,t)}catch(r){return h.error("EmailHTMLValidator",`Error fixing all ${t} issues`,r),{html:e,fixed:[]}}}autoFixCategory(e,t){if(this.isDisposed)throw new Error(w.VALIDATOR_DISPOSED);try{return this.autofixEngine.autoFixCategory(e,t)}catch(r){return h.error("EmailHTMLValidator",`Error fixing category ${t} issues`,r),{html:e,fixed:[]}}}getAutoFixableRules(){if(this.isDisposed)throw new Error(w.VALIDATOR_DISPOSED);try{return this.autofixEngine.getAutoFixableRules()}catch(e){return h.error("EmailHTMLValidator","Error getting auto-fixable rules",e),[]}}getRulesByCategory(e){if(this.isDisposed)throw new Error(w.VALIDATOR_DISPOSED);try{return this.autofixEngine.getRulesByCategory(e)}catch(t){return h.error("EmailHTMLValidator",`Error getting rules for category ${e}`,t),[]}}addRule(e){if(this.isDisposed)throw new Error(w.VALIDATOR_DISPOSED);try{this.validationEngine.addRule(e),this.autofixEngine.addRule(e),h.debug("EmailHTMLValidator",`Custom rule added: ${e.name}`)}catch(t){throw h.error("EmailHTMLValidator",`Error adding custom rule ${e.name}`,t),t}}removeRule(e){if(this.isDisposed)throw new Error(w.VALIDATOR_DISPOSED);try{this.validationEngine.removeRule(e),this.autofixEngine.removeRule(e),h.debug("EmailHTMLValidator",`Custom rule removed: ${e}`)}catch(t){throw h.error("EmailHTMLValidator",`Error removing custom rule ${e}`,t),t}}updateConfig(e){if(this.isDisposed)throw new Error(w.VALIDATOR_DISPOSED);try{if(e.maxHtmlSize&&e.maxHtmlSize<=0)throw new Error("maxHtmlSize must be positive");if(e.maxFileSize&&e.maxFileSize<=0)throw new Error("maxFileSize must be positive");this.config={...this.config,...e,rules:{...this.config.rules,...e.rules},targetClients:{...this.config.targetClients,...e.targetClients}},this.validationEngine.dispose(),this.autofixEngine.dispose(),this.validationEngine=new Je(this.config),this.autofixEngine=new Qe(this.config),h.debug("EmailHTMLValidator","Configuration updated successfully",{newConfig:e})}catch(t){throw h.error("EmailHTMLValidator","Error updating configuration",t),t}}setRuleEnabled(e,t){if(this.isDisposed)throw new Error(w.VALIDATOR_DISPOSED);if(!e)throw new Error(w.INVALID_RULE_NAME);try{this.config.rules[e]?this.config.rules[e].enabled=t:this.config.rules[e]={enabled:t},h.debug("EmailHTMLValidator",`Rule ${e} ${t?"enabled":"disabled"}`)}catch(r){throw h.error("EmailHTMLValidator",`Error setting rule ${e} enabled state`,r),r}}setRuleSeverity(e,t){if(this.isDisposed)throw new Error(w.VALIDATOR_DISPOSED);if(!e||!t)throw new Error("Rule name and severity are required");if(!["error","warning","info"].includes(t))throw new Error(w.INVALID_SEVERITY);try{this.config.rules[e]?this.config.rules[e].severity=t:this.config.rules[e]={enabled:!0,severity:t},h.debug("EmailHTMLValidator",`Rule ${e} severity set to ${t}`)}catch(r){throw h.error("EmailHTMLValidator",`Error setting rule ${e} severity`,r),r}}getConfig(){if(this.isDisposed)throw new Error(w.VALIDATOR_DISPOSED);return{...this.config}}getAvailableRules(){if(this.isDisposed)throw new Error(w.VALIDATOR_DISPOSED);try{return this.validationEngine.getAvailableRules()}catch(e){return h.error("EmailHTMLValidator","Error getting available rules",e),{}}}testRule(e,t){if(this.isDisposed)throw new Error(w.VALIDATOR_DISPOSED);try{return this.validationEngine.testRule(e,t)}catch(r){return h.error("EmailHTMLValidator",`Error testing rule ${e}`,r),[]}}getCompatibilityReport(e){if(this.isDisposed)throw new Error(w.VALIDATOR_DISPOSED);try{return this.validationEngine.getCompatibilityReport(e)}catch(t){return h.error("EmailHTMLValidator","Error generating compatibility report",t),{}}}getStats(){try{return{validation:{...this.validationStats},cache:{validation:this.validationEngine.getCacheStats(),autofix:this.autofixEngine.getFixHistoryStats()},isDisposed:this.isDisposed}}catch(e){return h.error("EmailHTMLValidator","Error getting statistics",e),{validation:this.validationStats,cache:{validation:{},autofix:{}},isDisposed:this.isDisposed}}}resetStats(){if(this.isDisposed)throw new Error(w.VALIDATOR_DISPOSED);this.validationStats={totalValidations:0,successfulValidations:0,totalAutoFixes:0,successfulAutoFixes:0,lastValidationTime:0,lastAutoFixTime:0},h.debug("EmailHTMLValidator",te.STATISTICS_RESET_PREFIX)}dispose(){if(!this.isDisposed)try{this.config.rules={},this.validationEngine.dispose(),this.autofixEngine.dispose(),this.cleanupInterval&&(clearInterval(this.cleanupInterval),this.cleanupInterval=void 0),this.isDisposed=!0,h.debug("EmailHTMLValidator",`EmailHTMLValidator ${te.DISPOSAL_PREFIX}`)}catch(e){h.error("EmailHTMLValidator","Error during disposal",e),this.isDisposed=!0}}isDisposedValidator(){return this.isDisposed}}new et({strictMode:!1,targetClients:{outlook:!0,gmail:!0,applemail:!0,thunderbird:!1,mobile:!0},checkAccessibility:!0,checkPerformance:!0,checkBestPractices:!0,maxFileSize:T.MAX_FILE_SIZE_KB,maxHtmlSize:T.MAX_HTML_SIZE_BYTES,requireAltText:!0,requireFallbacks:!0});const Yt=null,Kt=({html:a,onHtmlChange:e,validator:t,showCompactView:r=!1})=>{var He;const s=ke(),{mode:l,style:o}=je(),n=F.useMemo(()=>Me(l,o),[l,o]),u=F.useMemo(()=>({borderRadius:`${n.card.borderRadius}px`,background:n.card.background||S(s.palette.background.paper,.8),backdropFilter:n.card.backdropFilter,WebkitBackdropFilter:n.card.WebkitBackdropFilter,border:n.card.border,boxShadow:n.card.boxShadow}),[n,s.palette.background.paper]),[c,m]=F.useState(null),[E,f]=F.useState(!1),[v,I]=F.useState(!1),[_,L]=F.useState(0),[j,se]=F.useState(!1),[N,P]=F.useState(!1),[Y,fe]=F.useState("all"),[K,oe]=F.useState("all"),[J,me]=F.useState(""),X=F.useMemo(()=>t||new et,[t]);F.useEffect(()=>{if(!a||!a.trim()){m(null);return}se(!0);const d=setTimeout(()=>{try{const p=X.validate(a);m(p)}catch(p){h.error("EmailValidationPanel","Validation error",p);const b=p&&typeof p=="object"&&"message"in p?p.message:"Unknown error";m({isValid:!1,errors:[{rule:"validation-error",severity:"error",message:`Validation failed: ${b}`,category:"structure"}],warnings:[],suggestions:[],autoFixAvailable:!1,totalIssues:1,categories:{structure:1,accessibility:0,compatibility:0,performance:0,"best-practice":0},score:0})}finally{se(!1)}},300);return()=>clearTimeout(d)},[a,X]);const tt=async()=>{if(!(c!=null&&c.autoFixAvailable)||!e){h.warn("EmailValidationPanel","Auto-fix not available or no onHtmlChange callback");return}P(!0);try{const{html:d,fixed:p}=X.autoFix(a);p.length>0?(e(d),alert(`Successfully fixed ${p.length} issues:
${p.join(`
`)}`)):alert("No issues were auto-fixed. All issues may already be resolved or not auto-fixable.")}catch(d){alert(`Error during auto-fix: ${d&&typeof d=="object"&&"message"in d?d.message:"Unknown error"}`)}finally{P(!1)}},rt=async d=>{if(e){P(!0);try{const{html:p,fixed:b}=X.autoFixSpecificIssue(a,d);b?(e(p),alert(`Successfully fixed issue with rule: ${d}`)):alert(`No changes made for rule: ${d}. Issue may already be resolved.`)}catch(p){alert(`Error fixing issue: ${p&&typeof p=="object"&&"message"in p?p.message:"Unknown error"}`)}finally{P(!1)}}},st=async d=>{if(e){P(!0);try{const{html:p,fixed:b}=X.autoFixAllIssues(a,d);b.length>0?(e(p),alert(`Successfully fixed ${b.length} ${d} issues:
${b.join(`
`)}`)):alert(`No ${d} issues were fixed. All issues may already be resolved or not auto-fixable.`)}catch(p){alert(`Error fixing ${d} issues: ${p&&typeof p=="object"&&"message"in p?p.message:"Unknown error"}`)}finally{P(!1)}}},it=async d=>{if(e){P(!0);try{const{html:p,fixed:b}=X.autoFixCategory(a,d);b.length>0?(e(p),alert(`Successfully fixed ${b.length} issues in category ${d}:
${b.join(`
`)}`)):alert(`No issues in category ${d} were fixed. All issues may already be resolved or not auto-fixable.`)}catch(p){alert(`Error fixing category ${d} issues: ${p&&typeof p=="object"&&"message"in p?p.message:"Unknown error"}`)}finally{P(!1)}}},Fe=d=>{switch(d){case"error":return i.jsx(xe,{color:"error"});case"warning":return i.jsx(Pe,{color:"warning"});case"info":return i.jsx(_e,{color:"info"});default:return i.jsx(_e,{})}},at=d=>{switch(d){case"structure":return i.jsx(We,{color:"primary"});case"accessibility":return i.jsx(Ye,{color:"secondary"});case"compatibility":return i.jsx(re,{color:"info"});case"performance":return i.jsx(ce,{color:"warning"});case"best-practice":return i.jsx(Xe,{color:"success"});default:return i.jsx(_e,{})}},ot=d=>{switch(d){case"structure":return"primary";case"accessibility":return"secondary";case"compatibility":return"info";case"performance":return"warning";case"best-practice":return"success";default:return"default"}},nt=d=>{switch(d){case"structure":return"Structure";case"accessibility":return"Accessibility";case"compatibility":return"Compatibility";case"performance":return"Performance";case"best-practice":return"Best Practice";default:return d}},Z=F.useMemo(()=>{if(!c)return{errors:[],warnings:[],suggestions:[]};let p=[...c.errors,...c.warnings,...c.suggestions];if(Y!=="all"&&(p=p.filter(b=>b.severity===Y)),K!=="all"&&(p=p.filter(b=>b.category===K)),J.trim()){const b=J.toLowerCase();p=p.filter(G=>{var B;return G.message.toLowerCase().includes(b)||((B=G.suggestion)==null?void 0:B.toLowerCase().includes(b))||G.rule.toLowerCase().includes(b)})}return{errors:p.filter(b=>b.severity==="error"),warnings:p.filter(b=>b.severity==="warning"),suggestions:p.filter(b=>b.severity==="info")}},[c,Y,K,J]),be=(d,p,b)=>{if(!d||d.length===0)return null;const G=b==="error"?"error":b==="warning"?"warning":"info",B=G==="error"?s.palette.error:G==="warning"?s.palette.warning:s.palette.info,ie=S(B.main,s.palette.mode==="dark"?.6:.35),ne=n.card.border==="none"?"none":`1px solid ${ie}`,M=n.card.border==="none"?`${n.card.boxShadow}, 0 0 0 1px ${ie}`:n.card.boxShadow;return i.jsxs(At,{defaultExpanded:b==="error",sx:{mb:2,"&:before":{display:"none"},borderRadius:`${n.card.borderRadius}px`,background:n.card.background||S(s.palette.background.paper,.8),backdropFilter:n.card.backdropFilter,WebkitBackdropFilter:n.card.WebkitBackdropFilter,border:ne,boxShadow:M},children:[i.jsx(Tt,{expandIcon:i.jsx(Ee,{}),sx:{backgroundColor:S(B.main,s.palette.mode==="dark"?.22:.08),borderRadius:`${n.card.borderRadius}px ${n.card.borderRadius}px 0 0`},children:i.jsxs(y,{sx:{display:"flex",alignItems:"center",gap:2,width:"100%"},children:[Fe(b),i.jsxs(x,{variant:"subtitle1",component:"div",fontWeight:"bold",children:[p," (",d.length,")"]}),i.jsx(y,{sx:{flexGrow:1}}),d.some(C=>C.autoFixAvailable)&&e&&i.jsx(U,{size:"small",variant:"contained",startIcon:i.jsx(ae,{}),onClick:C=>{C.stopPropagation(),st(b)},disabled:j||N,color:G,sx:{minWidth:"auto"},children:N?"Fixing...":`Fix All (${d.filter(C=>C.autoFixAvailable).length})`})]})}),i.jsx(St,{sx:{p:0},children:i.jsx(vt,{dense:!0,sx:{p:0},children:d.map((C,z)=>i.jsxs(_t,{sx:{px:2,py:1,borderBottom:z<d.length-1?"1px solid":"none",borderBottomColor:"divider","&:last-child":{borderBottom:"none"}},children:[i.jsx(Ct,{sx:{minWidth:36},children:Fe(C.severity)}),i.jsx(It,{primary:i.jsx(x,{variant:"body2",component:"div",fontWeight:"medium",children:C.message}),secondary:i.jsxs(y,{sx:{mt:1},children:[C.line&&i.jsxs(x,{variant:"caption",component:"div",color:"text.secondary",sx:{mb:.5},children:[" Line ",C.line,C.column&&`, Column ${C.column}`]}),C.suggestion&&i.jsxs(x,{variant:"caption",component:"div",display:"block",sx:{mt:.5,fontStyle:"italic",backgroundColor:"action.hover",p:1,borderRadius:1,border:"1px solid",borderColor:"divider"},children:[" ",C.suggestion]}),C.category&&i.jsx(D,{size:"small",icon:at(C.category),label:nt(C.category),color:ot(C.category),variant:"outlined",sx:{mt:1,mr:1}}),i.jsx(D,{size:"small",label:C.rule,variant:"outlined",sx:{mt:1,fontSize:"0.7rem"}})]}),primaryTypographyProps:{component:"div"},secondaryTypographyProps:{component:"div"}}),C.autoFixAvailable&&e&&i.jsx(Ae,{title:"Fix this issue",children:i.jsx(ye,{size:"small",onClick:()=>rt(C.rule),sx:{ml:1},color:"primary",children:i.jsx(ae,{fontSize:"small"})})})]},`${C.rule}-${z}`))})})]})},lt=()=>{if(!c)return null;const d=[{key:"structure",label:"Structure",icon:i.jsx(We,{}),color:"primary"},{key:"accessibility",label:"Accessibility",icon:i.jsx(Ye,{}),color:"secondary"},{key:"compatibility",label:"Compatibility",icon:i.jsx(re,{}),color:"info"},{key:"performance",label:"Performance",icon:i.jsx(ce,{}),color:"warning"},{key:"best-practice",label:"Best Practice",icon:i.jsx(Xe,{}),color:"success"}];return i.jsx(V,{container:!0,spacing:2,sx:{mb:3},children:d.map(p=>{var B,ie,ne;const b=c.categories[p.key],G=b>0&&X.getRulesByCategory(p.key).some(M=>{var C;return(C=$[M])==null?void 0:C.autofix});return i.jsx(V,{item:!0,xs:12,sm:6,md:4,children:i.jsx(Te,{variant:"outlined",onClick:()=>oe(p.key),sx:{borderRadius:`${n.card.borderRadius}px`,background:(()=>{var Ne;const M=n.card.background||S(s.palette.background.paper,.8);if(b<=0)return M;const C=((Ne=s.palette[p.color])==null?void 0:Ne.main)??s.palette.primary.main,z=S(C,s.palette.mode==="dark"?.18:.06);return`linear-gradient(0deg, ${z}, ${z}), ${M}`})(),backdropFilter:n.card.backdropFilter,WebkitBackdropFilter:n.card.WebkitBackdropFilter,border:(()=>{var z;if(b<=0)return n.card.border;const M=((z=s.palette[p.color])==null?void 0:z.main)??s.palette.primary.main,C=S(M,s.palette.mode==="dark"?.7:.45);return n.card.border==="none"?n.card.border:`1px solid ${C}`})(),boxShadow:(()=>{var z;if(b<=0||n.card.border!=="none")return n.card.boxShadow;const M=((z=s.palette[p.color])==null?void 0:z.main)??s.palette.primary.main,C=S(M,s.palette.mode==="dark"?.7:.45);return`${n.card.boxShadow}, 0 0 0 1px ${C}`})(),transition:M=>M.transitions.create(["transform","box-shadow","border"],{duration:M.transitions.duration.short}),cursor:"pointer","&:hover":{transform:((B=n.card.hover)==null?void 0:B.transform)||"translateY(-4px)",boxShadow:((ie=n.card.hover)==null?void 0:ie.boxShadow)||(M=>M.shadows[4]),border:((ne=n.card.hover)==null?void 0:ne.border)||void 0}},children:i.jsxs(xt,{sx:{p:2,"&:last-child":{pb:2}},children:[i.jsxs(y,{sx:{display:"flex",alignItems:"center",gap:1,mb:1},children:[i.jsx(y,{sx:{color:`${p.color}.main`},children:p.icon}),i.jsx(x,{variant:"body2",component:"div",fontWeight:"bold",children:p.label})]}),i.jsxs(y,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[i.jsx(Ve,{badgeContent:b,color:p.color,children:i.jsx(D,{size:"small",label:b===0?"Perfect":`${b} issues`,color:b===0?"success":p.color,variant:b===0?"filled":"outlined"})}),G&&e&&b>0&&i.jsx(U,{size:"small",variant:"contained",startIcon:i.jsx(ae,{}),onClick:()=>it(p.key),disabled:j||N,color:p.color,sx:{borderRadius:2,textTransform:"none",fontWeight:500,boxShadow:M=>M.shadows[1],"&:hover":{boxShadow:M=>M.shadows[3]}},children:N?"Fixing...":`Fix All (${b})`})]})]})})},p.key)})})},ct=()=>c?i.jsxs(y,{sx:{mb:3,p:3,...u},children:[i.jsxs(x,{variant:"subtitle2",component:"div",sx:{mb:2,fontWeight:"bold",display:"flex",alignItems:"center",gap:1,color:"text.primary"},children:[i.jsx(Ke,{fontSize:"small"}),"Filters & Search"]}),i.jsxs(V,{container:!0,spacing:2,alignItems:"center",children:[i.jsx(V,{item:!0,xs:12,sm:6,md:3,children:i.jsxs(Ge,{fullWidth:!0,size:"small",children:[i.jsx(ze,{children:"Severity"}),i.jsxs(Ue,{value:Y,label:"Severity",onChange:d=>fe(d.target.value),children:[i.jsx(W,{value:"all",children:"All Severities"}),i.jsx(W,{value:"error",children:"Errors"}),i.jsx(W,{value:"warning",children:"Warnings"}),i.jsx(W,{value:"info",children:"Suggestions"})]})]})}),i.jsx(V,{item:!0,xs:12,sm:6,md:3,children:i.jsxs(Ge,{fullWidth:!0,size:"small",children:[i.jsx(ze,{children:"Category"}),i.jsxs(Ue,{value:K,label:"Category",onChange:d=>oe(d.target.value),children:[i.jsx(W,{value:"all",children:"All Categories"}),i.jsx(W,{value:"structure",children:"Structure"}),i.jsx(W,{value:"accessibility",children:"Accessibility"}),i.jsx(W,{value:"compatibility",children:"Compatibility"}),i.jsx(W,{value:"performance",children:"Performance"}),i.jsx(W,{value:"best-practice",children:"Best Practice"})]})]})}),i.jsx(V,{item:!0,xs:12,sm:12,md:6,children:i.jsx($e,{fullWidth:!0,size:"small",placeholder:"Search in messages, suggestions, or rules...",value:J,onChange:d=>me(d.target.value),InputProps:{startAdornment:i.jsx(yt,{position:"start",children:i.jsx(Et,{fontSize:"small"})})}})})]}),i.jsxs(y,{sx:{mt:2,display:"flex",alignItems:"center",justifyContent:"space-between",p:1,backgroundColor:"background.paper",borderRadius:1,border:"1px solid",borderColor:"divider"},children:[i.jsxs(x,{variant:"caption",color:"text.secondary",children:["Showing"," ",Z.errors.length+Z.warnings.length+Z.suggestions.length," ","of ",c.totalIssues," issues"]}),(Y!=="all"||K!=="all"||J.trim())&&i.jsx(U,{size:"small",variant:"outlined",color:"secondary",onClick:()=>{fe("all"),oe("all"),me("")},sx:{borderRadius:2,textTransform:"none",fontWeight:500},children:"Clear Filters"})]})]}):null,ut=()=>{if(!a||!a.trim())return null;try{const d=X.getCompatibilityReport(a);return i.jsxs(y,{sx:{mt:2},children:[i.jsx(x,{variant:"subtitle2",component:"div",sx:{mb:1,fontWeight:"bold"},children:"Email Client Compatibility"}),Object.entries(d).map(([p,b])=>i.jsxs(y,{sx:{mb:1},children:[i.jsxs(y,{sx:{display:"flex",alignItems:"center",gap:1},children:[p==="outlook"&&i.jsx(re,{fontSize:"small"}),p==="gmail"&&i.jsx(Rt,{fontSize:"small"}),p==="mobile"&&i.jsx(wt,{fontSize:"small"}),i.jsx(x,{variant:"body2",component:"div",sx:{textTransform:"capitalize",flexGrow:1},children:p}),i.jsx(D,{size:"small",label:b.compatible?"Compatible":"Issues",color:b.compatible?"success":"warning",variant:"outlined"})]}),!b.compatible&&b.issues&&b.issues.length>0&&i.jsx(y,{sx:{ml:3,mt:.5},children:b.issues.map((G,B)=>i.jsxs(x,{variant:"caption",component:"div",color:"warning.main",display:"block",children:[" ",G]},B))})]},p))]})}catch(d){return h.error("EmailValidationPanel","Error generating compatibility report",d),i.jsx(y,{sx:{mt:2},children:i.jsx(x,{variant:"subtitle2",component:"div",color:"error",children:"Error generating compatibility report"})})}};return!c&&!j?null:r?i.jsxs(y,{sx:{display:"flex",alignItems:"center",gap:1},children:[j?i.jsx(D,{size:"small",label:"Validating...",color:"info"}):N?i.jsx(D,{size:"small",label:"Fixing...",color:"warning"}):c!=null&&c.isValid?i.jsx(D,{size:"small",icon:i.jsx(Oe,{}),label:"Email Safe",color:"success"}):i.jsx(D,{size:"small",icon:i.jsx(xe,{}),label:`${(c==null?void 0:c.totalIssues)||0} Issues`,color:"error"}),c&&i.jsx(ye,{size:"small",onClick:()=>f(!E),children:E?i.jsx(De,{}):i.jsx(Ee,{})})]}):i.jsxs(ht,{sx:{p:2,mb:2,...u},children:[i.jsx("style",{children:`
          @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
          }

          @keyframes slideIn {
            from { transform: translateX(20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
          }

          .tab-content {
            animation: slideIn 0.3s ease-out;
          }
        `}),i.jsxs(y,{sx:{display:"flex",alignItems:"center",gap:2,mb:2},children:[i.jsxs(y,{sx:{display:"flex",alignItems:"center",gap:1},children:[j?i.jsx(D,{icon:i.jsx(he,{}),label:"Validating...",color:"info"}):c!=null&&c.isValid?i.jsx(D,{icon:i.jsx(Oe,{}),label:"Email Safe",color:"success"}):i.jsx(D,{icon:i.jsx(xe,{}),label:`${((He=c==null?void 0:c.errors)==null?void 0:He.length)||0} Errors`,color:"error"}),c&&c.warnings&&c.warnings.length>0&&i.jsx(D,{icon:i.jsx(Pe,{}),label:`${c.warnings.length} Warnings`,color:"warning"})]}),i.jsx(y,{sx:{flexGrow:1}}),c&&i.jsxs(y,{sx:{display:"flex",alignItems:"center",gap:1},children:[i.jsx(x,{variant:"body2",color:"text.secondary",children:"Score:"}),i.jsx(D,{label:`${c.score}/100`,color:c.score>=80?"success":c.score>=60?"warning":"error",variant:"outlined",size:"small"})]}),i.jsx(Ae,{title:"Validation Settings",children:i.jsx(ye,{size:"small",onClick:()=>I(!0),children:i.jsx(ge,{})})}),Yt,(c==null?void 0:c.autoFixAvailable)&&e&&i.jsx(Ae,{title:"Auto-fix All Issues",children:i.jsx(U,{size:"small",variant:"contained",startIcon:i.jsx(ae,{}),onClick:tt,disabled:j||N,color:"primary",sx:{borderRadius:2,textTransform:"none",fontWeight:500,boxShadow:d=>d.shadows[2],"&:hover":{boxShadow:d=>d.shadows[4]}},children:N?"Fixing...":`Auto-fix All (${c.totalIssues})`})}),i.jsx(U,{size:"small",onClick:()=>f(!E),endIcon:E?i.jsx(De,{}):i.jsx(Ee,{}),variant:"outlined",sx:{borderRadius:2,textTransform:"none",fontWeight:500,borderColor:"divider",color:"text.secondary","&:hover":{borderColor:"text.primary",backgroundColor:"action.hover"}},children:"Details"})]}),c&&i.jsxs(y,{sx:{mb:2},children:[i.jsxs(y,{sx:{display:"flex",justifyContent:"space-between",mb:1},children:[i.jsx(x,{variant:"caption",color:"text.secondary",children:"Validation Progress"}),i.jsxs(x,{variant:"caption",color:"text.secondary",children:[c.score,"%"]})]}),i.jsx(pt,{variant:"determinate",value:c.score,color:c.score>=80?"success":c.score>=60?"warning":"error",sx:{height:6,borderRadius:3}})]}),i.jsxs(ft,{in:E,children:[i.jsx(mt,{sx:{mb:2}}),c&&lt(),i.jsx(y,{sx:{mb:2,borderBottom:"1px solid",borderBottomColor:"divider",background:n.card.background||S(s.palette.background.paper,.7),backdropFilter:n.card.backdropFilter,WebkitBackdropFilter:n.card.WebkitBackdropFilter,borderRadius:"8px 8px 0 0",p:1},children:i.jsxs(bt,{value:_,onChange:(d,p)=>L(p),sx:{"& .MuiTab-root":{minHeight:48,textTransform:"none",fontWeight:500,fontSize:"0.875rem",transition:"all 0.2s ease-in-out",borderRadius:"8px 8px 0 0",margin:"0 4px",color:"text.secondary"},"& .Mui-selected":{fontWeight:600,color:"primary.main",backgroundColor:d=>S(d.palette.primary.main,d.palette.mode==="dark"?.24:.08)},"& .MuiTabs-indicator":{height:4,borderRadius:"4px 4px 0 0",backgroundColor:"primary.main",boxShadow:d=>d.shadows[2]},"& .MuiTab-root:hover":{backgroundColor:d=>S(d.palette.primary.main,d.palette.mode==="dark"?.16:.04),transform:"translateY(-1px)"}},variant:"fullWidth",textColor:"primary",indicatorColor:"primary",children:[i.jsx(le,{label:i.jsxs(y,{sx:{display:"flex",alignItems:"center",gap:1},children:[i.jsx(he,{fontSize:"small"}),"Issues",c&&c.totalIssues>0&&i.jsx(Ve,{badgeContent:c.totalIssues,color:"error",sx:{ml:1},max:99})]})}),i.jsx(le,{label:i.jsxs(y,{sx:{display:"flex",alignItems:"center",gap:1},children:[i.jsx(re,{fontSize:"small"}),"Compatibility"]})}),i.jsx(le,{label:i.jsxs(y,{sx:{display:"flex",alignItems:"center",gap:1},children:[i.jsx(ce,{fontSize:"small"}),"Performance"]})}),i.jsx(le,{label:i.jsxs(y,{sx:{display:"flex",alignItems:"center",gap:1},children:[i.jsx(ge,{fontSize:"small"}),"Settings"]})})]})}),i.jsxs(y,{className:"tab-content",sx:{minHeight:200,position:"relative",p:2,background:n.card.background||S(s.palette.background.paper,.8),backdropFilter:n.card.backdropFilter,WebkitBackdropFilter:n.card.WebkitBackdropFilter,borderRadius:`0 0 ${n.card.borderRadius}px ${n.card.borderRadius}px`,border:n.card.border,boxShadow:n.card.boxShadow,borderTop:"none"},children:[_===0&&c&&i.jsxs(y,{children:[i.jsxs(x,{variant:"h6",component:"div",sx:{mb:2,display:"flex",alignItems:"center",gap:1,p:2,backgroundColor:d=>S(d.palette.error.main,d.palette.mode==="dark"?.22:.08),borderRadius:2,border:"1px solid",borderColor:d=>S(d.palette.error.main,d.palette.mode==="dark"?.6:.35),color:"error.main",fontWeight:600,boxShadow:d=>d.shadows[1]},children:[i.jsx(he,{color:"error"}),"Issues & Validation Results"]}),ct(),Z.errors.length===0&&Z.warnings.length===0&&Z.suggestions.length===0?i.jsx(pe,{severity:"info",sx:{borderRadius:2},children:"No issues match the current filters. Try adjusting your search criteria."}):i.jsxs(i.Fragment,{children:[be(Z.errors,"Errors","error"),be(Z.warnings,"Warnings","warning"),be(Z.suggestions,"Suggestions","info")]}),c.totalIssues===0&&i.jsx(pe,{severity:"success",sx:{borderRadius:2},children:" Your HTML is email-safe! No issues found."})]}),_===1&&i.jsxs(y,{children:[i.jsxs(x,{variant:"h6",component:"div",sx:{mb:2,display:"flex",alignItems:"center",gap:1,p:2,backgroundColor:d=>S(d.palette.info.main,d.palette.mode==="dark"?.22:.08),borderRadius:2,border:"1px solid",borderColor:d=>S(d.palette.info.main,d.palette.mode==="dark"?.6:.35),color:"info.main"},children:[i.jsx(re,{color:"info"}),"Email Client Compatibility"]}),ut(),i.jsxs(y,{sx:{mt:3,p:2,backgroundColor:d=>S(d.palette.info.main,d.palette.mode==="dark"?.18:.08),borderRadius:2,border:"1px solid",borderColor:d=>S(d.palette.info.main,d.palette.mode==="dark"?.6:.35)},children:[i.jsx(x,{variant:"subtitle2",component:"div",sx:{mb:1,fontWeight:"bold"},children:" Compatibility Tips"}),i.jsxs(x,{variant:"body2",component:"div",sx:{mb:1},children:[" ",i.jsx("strong",{children:"Outlook:"})," Use table-based layout, avoid flexbox/grid"]}),i.jsxs(x,{variant:"body2",component:"div",sx:{mb:1},children:[" ",i.jsx("strong",{children:"Gmail:"})," Inline styles work best, external CSS may be stripped"]}),i.jsxs(x,{variant:"body2",component:"div",sx:{mb:1},children:[" ",i.jsx("strong",{children:"Mobile:"})," Use responsive design with max-width"]})]})]}),_===2&&i.jsxs(y,{children:[i.jsxs(x,{variant:"h6",component:"div",sx:{mb:2,display:"flex",alignItems:"center",gap:1,p:2,backgroundColor:d=>S(d.palette.warning.main,d.palette.mode==="dark"?.22:.08),borderRadius:2,border:"1px solid",borderColor:d=>S(d.palette.warning.main,d.palette.mode==="dark"?.6:.35),color:"warning.main",fontWeight:600,boxShadow:d=>d.shadows[1]},children:[i.jsx(ce,{color:"warning"}),"Performance Analysis"]}),c&&i.jsxs(V,{container:!0,spacing:2,sx:{mb:3},children:[i.jsx(V,{item:!0,xs:12,sm:6,children:i.jsxs(Te,{variant:"outlined",sx:{p:2,...u},children:[i.jsx(x,{variant:"subtitle2",component:"div",sx:{mb:1,fontWeight:"bold"},children:" File Size"}),i.jsxs(x,{variant:"h4",component:"div",color:c.score>=80?"success.main":"warning.main",children:[(a.length/1024).toFixed(1)," KB"]}),i.jsx(x,{variant:"caption",component:"div",color:"text.secondary",children:c.score>=80?" Optimal size":" Consider optimization"})]})}),i.jsx(V,{item:!0,xs:12,sm:6,children:i.jsxs(Te,{variant:"outlined",sx:{p:2,...u},children:[i.jsx(x,{variant:"subtitle2",component:"div",sx:{mb:1,fontWeight:"bold"},children:" Validation Score"}),i.jsxs(x,{variant:"h4",component:"div",color:c.score>=80?"success.main":c.score>=60?"warning.main":"error.main",children:[c.score,"/100"]}),i.jsx(x,{variant:"caption",component:"div",color:"text.secondary",children:c.score>=80?"Excellent":c.score>=60?"Good":"Needs improvement"})]})})]}),i.jsxs(y,{sx:{p:2,backgroundColor:d=>S(d.palette.warning.main,d.palette.mode==="dark"?.18:.08),borderRadius:2,border:"1px solid",borderColor:d=>S(d.palette.warning.main,d.palette.mode==="dark"?.6:.35)},children:[i.jsx(x,{variant:"subtitle2",component:"div",sx:{mb:1,fontWeight:"bold"},children:" Performance Recommendations"}),i.jsx(x,{variant:"body2",component:"div",sx:{mb:1},children:" Keep HTML size under 102KB for optimal email delivery"}),i.jsx(x,{variant:"body2",component:"div",sx:{mb:1},children:" Use inline styles instead of external CSS"}),i.jsx(x,{variant:"body2",component:"div",sx:{mb:1},children:" Optimize images and use appropriate dimensions"}),i.jsx(x,{variant:"body2",component:"div",sx:{mb:1},children:" Minimize table nesting for better rendering"})]})]}),_===3&&i.jsxs(y,{children:[i.jsxs(x,{variant:"h6",component:"div",sx:{mb:2,display:"flex",alignItems:"center",gap:1,p:2,backgroundColor:d=>S(d.palette.success.main,d.palette.mode==="dark"?.22:.08),borderRadius:2,border:"1px solid",borderColor:d=>S(d.palette.success.main,d.palette.mode==="dark"?.6:.35),color:"success.main",fontWeight:600,boxShadow:d=>d.shadows[1]},children:[i.jsx(ge,{color:"primary"}),"Validation Settings"]}),i.jsxs(y,{sx:{mb:3},children:[i.jsx(x,{variant:"subtitle2",component:"div",sx:{mb:2,fontWeight:"bold"},children:"Quick Actions"}),i.jsxs(V,{container:!0,spacing:2,children:[i.jsx(V,{item:!0,xs:12,sm:6,children:i.jsx(U,{fullWidth:!0,variant:"contained",startIcon:i.jsx(ae,{}),onClick:()=>I(!0),sx:{mb:1,borderRadius:2,textTransform:"none",fontWeight:500,boxShadow:d=>d.shadows[2],"&:hover":{boxShadow:d=>d.shadows[4]}},children:"Advanced Settings"})}),i.jsx(V,{item:!0,xs:12,sm:6,children:i.jsx(U,{fullWidth:!0,variant:"outlined",startIcon:i.jsx(Ke,{}),onClick:()=>{fe("all"),oe("all"),me("")},sx:{borderRadius:2,textTransform:"none",fontWeight:500,borderColor:"divider",color:"text.secondary","&:hover":{borderColor:"text.primary",backgroundColor:"action.hover"}},children:"Reset Filters"})})]})]}),i.jsxs(y,{sx:{p:2,backgroundColor:"action.hover",borderRadius:2},children:[i.jsx(x,{variant:"subtitle2",component:"div",sx:{mb:1,fontWeight:"bold"},children:"Current Configuration"}),i.jsxs(x,{variant:"body2",component:"div",sx:{mb:.5},children:[" Severity Filter: ",Y==="all"?"All":Y]}),i.jsxs(x,{variant:"body2",component:"div",sx:{mb:.5},children:[" Category Filter: ",K==="all"?"All":K]}),i.jsxs(x,{variant:"body2",component:"div",sx:{mb:.5},children:[" Search Query: ",J||"None"]}),i.jsxs(x,{variant:"body2",component:"div",children:[" Total Rules: ",Object.keys($).length]})]})]})]})]}),i.jsx(qt,{open:v,onClose:()=>I(!1),validator:X})]})},qt=({open:a,onClose:e,validator:t})=>{const r=ke(),{mode:s,style:l}=je(),o=F.useMemo(()=>Me(s,l),[s,l]),[n,u]=F.useState(t.getConfig()),c=t.getAvailableRules(),m=()=>{try{t.updateConfig(n),e()}catch(f){h.error("ValidationSettingsDialog","Error saving validation config",f)}},E=(f,v)=>{u(I=>({...I,rules:{...I.rules,[f]:{...I.rules[f],enabled:v}}}))};return i.jsxs(Lt,{open:a,onClose:e,maxWidth:"md",fullWidth:!0,PaperProps:{sx:{borderRadius:`${o.card.borderRadius}px`,background:o.card.background||S(r.palette.background.paper,.9),backdropFilter:o.card.backdropFilter,WebkitBackdropFilter:o.card.WebkitBackdropFilter,border:o.card.border,boxShadow:o.card.boxShadow}},children:[i.jsx(kt,{sx:{backgroundColor:"background.default",borderBottom:"1px solid",borderBottomColor:"divider",fontWeight:600},children:"Validation Settings"}),i.jsxs(jt,{sx:{p:3},children:[i.jsxs(y,{sx:{mb:3},children:[i.jsxs(x,{variant:"h6",component:"div",sx:{mb:2,p:2,backgroundColor:f=>S(f.palette.info.main,f.palette.mode==="dark"?.22:.08),borderRadius:2,border:"1px solid",borderColor:f=>S(f.palette.info.main,f.palette.mode==="dark"?.6:.35),color:"info.main",fontWeight:600,display:"flex",alignItems:"center",gap:1},children:[i.jsx(he,{fontSize:"small"}),"Validation Rules"]}),i.jsx(Be,{children:Object.entries(c).map(([f,v])=>{var I;return i.jsx(Se,{control:i.jsx(ve,{checked:((I=n.rules[f])==null?void 0:I.enabled)??v.enabled,onChange:_=>E(f,_.target.checked),color:"primary"}),label:i.jsxs(y,{sx:{p:1,backgroundColor:"action.hover",borderRadius:1,border:"1px solid",borderColor:"divider",flex:1},children:[i.jsx(x,{variant:"body2",component:"div",sx:{fontWeight:500},children:v.displayName}),i.jsx(x,{variant:"caption",component:"div",color:"text.secondary",children:v.description})]}),sx:{alignItems:"flex-start",mb:1,p:1,borderRadius:1,"&:hover":{backgroundColor:"action.hover"}}},f)})})]}),i.jsxs(y,{sx:{mb:3},children:[i.jsxs(x,{variant:"h6",component:"div",sx:{mb:2,p:2,backgroundColor:f=>S(f.palette.warning.main,f.palette.mode==="dark"?.22:.08),borderRadius:2,border:"1px solid",borderColor:f=>S(f.palette.warning.main,f.palette.mode==="dark"?.6:.35),color:"warning.main",fontWeight:600,display:"flex",alignItems:"center",gap:1},children:[i.jsx(re,{fontSize:"small"}),"Target Email Clients"]}),i.jsx(Be,{children:Object.entries(n.targetClients).map(([f,v])=>i.jsx(Se,{control:i.jsx(ve,{checked:v,onChange:I=>u(_=>({..._,targetClients:{..._.targetClients,[f]:I.target.checked}})),color:"primary"}),label:i.jsx(y,{sx:{p:1,backgroundColor:"action.hover",borderRadius:1,border:"1px solid",borderColor:"divider",flex:1},children:i.jsx(x,{variant:"body2",component:"div",sx:{fontWeight:500},children:f.charAt(0).toUpperCase()+f.slice(1)})}),sx:{alignItems:"flex-start",mb:1,p:1,borderRadius:1,"&:hover":{backgroundColor:"action.hover"}}},f))})]}),i.jsxs(y,{sx:{p:2,backgroundColor:f=>S(f.palette.secondary.main,f.palette.mode==="dark"?.22:.08),borderRadius:2,border:"1px solid",borderColor:f=>S(f.palette.secondary.main,f.palette.mode==="dark"?.6:.35)},children:[i.jsxs(x,{variant:"h6",component:"div",sx:{mb:2,color:"secondary.main",fontWeight:600,display:"flex",alignItems:"center",gap:1},children:[i.jsx(ge,{fontSize:"small"}),"Advanced Options"]}),i.jsxs(y,{sx:{mb:2},children:[i.jsx(x,{variant:"body2",component:"div",sx:{mb:1,fontWeight:500},children:"Max HTML Size (KB)"}),i.jsx($e,{type:"number",size:"small",value:Math.round(n.maxHtmlSize/1024),onChange:f=>{const v=parseInt(f.target.value);!isNaN(v)&&v>0&&u(I=>({...I,maxHtmlSize:v*1024}))},inputProps:{min:1,max:1e3},sx:{width:120},helperText:`Current: ${Math.round(n.maxHtmlSize/1024)}KB`})]}),i.jsx(Se,{control:i.jsx(ve,{checked:n.strictMode,onChange:f=>u(v=>({...v,strictMode:f.target.checked})),color:"secondary"}),label:i.jsx(y,{sx:{p:1,backgroundColor:"action.hover",borderRadius:1,border:"1px solid",borderColor:"divider",flex:1},children:i.jsx(x,{variant:"body2",component:"div",sx:{fontWeight:500},children:"Strict Mode (treat warnings as errors)"})}),sx:{alignItems:"flex-start",p:1,borderRadius:1,"&:hover":{backgroundColor:"action.hover"}}})]})]}),i.jsxs(Mt,{sx:{p:3,borderTop:"1px solid",borderTopColor:"divider"},children:[i.jsx(U,{onClick:e,sx:{borderRadius:2,textTransform:"none",fontWeight:500,px:3},children:"Cancel"}),i.jsx(U,{onClick:m,variant:"contained",sx:{borderRadius:2,textTransform:"none",fontWeight:500,px:3,boxShadow:f=>f.shadows[2],"&:hover":{boxShadow:f=>f.shadows[4]}},children:"Save"})]})]})},er=()=>{const a=ke(),{mode:e,style:t}=je(),r=$t.useMemo(()=>Me(e,t),[e,t]),s=Ft(a,e,t),{editorHtml:l,setEditorHtml:o,subject:n,setSubject:u,loading:c,sendEmail:m,isReadyToSend:E,areCredentialsValid:f,serverStatus:v}=Ht(),I=()=>{m()},_=()=>{o("")},L=c||!E||!f||v==="offline";return i.jsxs(y,{sx:{height:"100%",display:"flex",flexDirection:"column",p:2},children:[i.jsxs(y,{sx:{flexGrow:1,overflow:"auto",pr:1},children:[i.jsxs(y,{sx:{mb:3,display:"flex",alignItems:"center",gap:1},children:[i.jsx(Nt,{}),i.jsx(x,{variant:"h6",children:"Email Template Editor"})]}),v==="offline"&&i.jsx(pe,{severity:"error",sx:{mb:3},children:"Email server is offline. Please start the backend server."}),i.jsxs(Ot,{spacing:3,children:[i.jsx($e,{label:"Email Subject",value:n,onChange:j=>u(j.target.value),fullWidth:!0,placeholder:"Enter email subject...",helperText:"A descriptive subject line for your email",sx:{"& .MuiOutlinedInput-root":{backgroundColor:"background.paper"}}}),i.jsx(y,{children:i.jsx(Kt,{html:l,onHtmlChange:o,showCompactView:!1})}),i.jsxs(y,{children:[i.jsx(x,{variant:"subtitle2",sx:{mb:2,color:"text.secondary",fontWeight:500},children:"HTML Content:"}),i.jsx(Ze,{backgroundAlpha:.85,sx:{overflow:"hidden",border:r.card.border==="none"?"1px solid":r.card.border,borderColor:r.card.border==="none"?"divider":void 0,"& .cm-selectionLayer .cm-selectionBackground":{backgroundColor:`${S(a.palette.primary.main,.25)} !important`},"& .cm-selectionBackground":{backgroundColor:`${S(a.palette.primary.main,.25)} !important`},"& .cm-content ::selection":{backgroundColor:`${S(a.palette.primary.main,.25)} !important`}},children:i.jsx(Dt,{value:l,onChange:j=>o(j),height:"400px",extensions:[Pt(),...s],theme:void 0,basicSetup:{lineNumbers:!0,foldGutter:!0,dropCursor:!0,allowMultipleSelections:!1,indentOnInput:!0,bracketMatching:!0,closeBrackets:!0,autocompletion:!0,highlightSelectionMatches:!0,searchKeymap:!0}})})]})]})]}),i.jsx(Ze,{backgroundAlpha:.9,sx:{position:"sticky",bottom:0,p:2,mx:-2,mt:2,zIndex:10,borderRadius:0,borderLeft:"none",borderRight:"none",borderBottom:"none"},children:i.jsxs(y,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:2},children:[i.jsx(y,{sx:{display:"flex",alignItems:"center",gap:2},children:i.jsx(U,{variant:"outlined",startIcon:i.jsx(Vt,{}),onClick:_,size:"medium",color:"warning",sx:{borderColor:"warning.main",color:"warning.main","&:hover":{borderColor:"warning.dark",backgroundColor:"warning.50"}},children:"Clear Editor"})}),i.jsxs(y,{sx:{display:"flex",alignItems:"center",gap:2},children:[!f&&i.jsx(pe,{severity:"warning",sx:{py:.5,px:2,fontSize:"0.875rem"},children:"Configure credentials first"}),i.jsx(U,{variant:"contained",startIcon:i.jsx(Gt,{}),onClick:I,disabled:L,size:"large",sx:{minWidth:160,height:48,fontSize:"1rem",fontWeight:600,bgcolor:L?void 0:"success.main","&:hover":{bgcolor:L?void 0:"success.dark",transform:"translateY(-1px)",boxShadow:a.shadows[4]},"&:disabled":{opacity:.6},transition:"all 0.2s ease-in-out"},children:c?"Sending...":"Send Email"})]})]})})]})};export{er as EmailHtmlEditor,er as default};

# üõ°Ô∏è Upload Error Handling & Robustness Improvements

## –û–≥–ª—è–¥

–ü—Ä–æ–≤–µ–¥–µ–Ω–æ –ø–æ–≤–Ω–∏–π –∞—É–¥–∏—Ç —Ç–∞ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è –æ–±—Ä–æ–±–∫–∏ –ø–æ–º–∏–ª–æ–∫ –¥–ª—è —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—É –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–∞ storage. –°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä –Ω–∞–¥—ñ–π–Ω–æ –ø—Ä–∞—Ü—é—î –≤ —Ä—ñ–∑–Ω–∏—Ö —Å–∫–ª–∞–¥–Ω–∏—Ö —Å—Ü–µ–Ω–∞—Ä—ñ—è—Ö.

---

## ‚úÖ –í–∏–ø—Ä–∞–≤–ª–µ–Ω—ñ –ø—Ä–æ–±–ª–µ–º–∏

### 1. **–ú–Ω–æ–∂–∏–Ω–Ω—ñ —Ñ–∞–π–ª–∏**
- ‚úÖ –ü–æ—Å–ª—ñ–¥–æ–≤–Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑ –ø—Ä–æ–≥—Ä–µ—Å–æ–º `[N/M]`
- ‚úÖ –Ø–∫—â–æ –æ–¥–∏–Ω —Ñ–∞–π–ª –ø–∞–¥–∞—î, —ñ–Ω—à—ñ –ø—Ä–æ–¥–æ–≤–∂—É—é—Ç—å –∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—Ç–∏—Å—å
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–∏–π –∑–≤—ñ—Ç: —Å–∫—ñ–ª—å–∫–∏ —É—Å–ø—ñ—à–Ω–æ, —Å–∫—ñ–ª—å–∫–∏ –∑ –ø–æ–º–∏–ª–∫–∞–º–∏
- ‚úÖ –ó–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è –¥—É–±–ª—ñ–∫–∞—Ç–∞–º —Ñ–∞–π–ª—ñ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ

### 2. **–°–ª–∞–±–∫–∏–π —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç / –í—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –∑'—î–¥–Ω–∞–Ω–Ω—è**
- ‚úÖ **Frontend timeout**: 30s –¥–ª—è prepare, 180s –¥–ª—è storage upload
- ‚úÖ **Backend timeout**: –∑–±—ñ–ª—å—à–µ–Ω–æ –¥–æ 5 —Ö–≤–∏–ª–∏–Ω (300s) –¥–ª—è –ø–æ–≤—ñ–ª—å–Ω–æ–≥–æ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç—É
- ‚úÖ –°–ø–µ—Ü–∏—Ñ—ñ—á–Ω—ñ –ø–æ–º–∏–ª–∫–∏ –¥–ª—è —Ä—ñ–∑–Ω–∏—Ö —Ç–∏–ø—ñ–≤ –º–µ—Ä–µ–∂–µ–≤–∏—Ö –ø—Ä–æ–±–ª–µ–º:
  - "–ù–µ–º–∞—î –∑'—î–¥–Ω–∞–Ω–Ω—è –∑ —Å–µ—Ä–≤–µ—Ä–æ–º"
  - "Timeout: —Å–µ—Ä–≤–µ—Ä –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î"
  - "Storage server not found"
  - "Cannot connect to storage server"

### 3. **–î–æ–≤–≥–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è**
- ‚úÖ –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø—Ä–æ–≥—Ä–µ—Å—É `[1/5]`, `[2/5]`, —ñ —Ç.–¥.
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–∏–π –ª–æ–≥ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ —Ñ–∞–π–ª—É
- ‚úÖ Extended timeouts (–¥–æ 5 —Ö–≤–∏–ª–∏–Ω –Ω–∞ —Ñ–∞–π–ª)
- ‚úÖ –ó–±—ñ–ª—å—à–µ–Ω–∏–π `maxBuffer` –¥–ª—è –≤–µ–ª–∏–∫–∏—Ö –ª–æ–≥—ñ–≤

### 4. **–°–∫–∞—Å—É–≤–∞–Ω–Ω—è –æ–ø–µ—Ä–∞—Ü—ñ—ó**
- ‚úÖ **AbortController** –¥–ª—è —Å–∫–∞—Å—É–≤–∞–Ω–Ω—è fetch –∑–∞–ø–∏—Ç—ñ–≤
- ‚úÖ –ö–Ω–æ–ø–∫–∞ "–°–∫–∞—Å—É–≤–∞—Ç–∏" –≤ –¥—ñ–∞–ª–æ–∑—ñ (—á–µ—Ä–≤–æ–Ω–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ)
- ‚úÖ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å–∫–∞—Å—É–≤–∞–Ω–Ω—è –º—ñ–∂ —Ñ–∞–π–ª–∞–º–∏
- ‚úÖ Cleanup temp —Ñ–∞–π–ª—ñ–≤ –ø—Ä–∏ —Å–∫–∞—Å—É–≤–∞–Ω–Ω—ñ
- ‚úÖ Graceful handling: "–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–∫–∞—Å–æ–≤–∞–Ω–æ"

### 5. **Race Conditions**
- ‚úÖ –ó–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è –º–Ω–æ–∂–∏–Ω–Ω–∏–º –æ–¥–Ω–æ—á–∞—Å–Ω–∏–º –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è–º
- ‚úÖ State `isUploading` –±–ª–æ–∫—É—î –ø–æ–≤—Ç–æ—Ä–Ω—ñ –∑–∞–ø–∏—Ç–∏
- ‚úÖ Disabled –∫–Ω–æ–ø–∫–∏ –ø—ñ–¥ —á–∞—Å –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è

### 6. **Cleanup & Resource Management**
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –≤–∏–¥–∞–ª–µ–Ω–Ω—è temp —Ñ–∞–π–ª—ñ–≤ –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
- ‚úÖ Cleanup –ø—Ä–∏ –ø–æ–º–∏–ª–∫–∞—Ö
- ‚úÖ Cleanup –ø—Ä–∏ —Å–∫–∞—Å—É–≤–∞–Ω–Ω—ñ
- ‚úÖ –£–Ω—ñ–∫–∞–ª—å–Ω—ñ —ñ–º–µ–Ω–∞ –¥–ª—è temp —Ñ–∞–π–ª—ñ–≤ (–∑–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è –∫–æ–Ω—Ñ–ª—ñ–∫—Ç–∞–º)
- ‚úÖ Path sanitization (–±–µ–∑–ø–µ–∫–∞)

---

## üîß –¢–µ—Ö–Ω—ñ—á–Ω—ñ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è

### Frontend (`ImageProcessor.tsx`)

#### –î–æ–¥–∞–Ω–æ:
```typescript
const [isUploading, setIsUploading] = useState(false);
const uploadAbortControllerRef = useRef<AbortController | null>(null);
```

#### –ù–æ–≤–∞ –ª–æ–≥—ñ–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è:
1. **–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ race condition**
   ```typescript
   if (isUploading) {
     throw new Error("–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤–∂–µ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è");
   }
   ```

2. **AbortController –¥–ª—è —Å–∫–∞—Å—É–≤–∞–Ω–Ω—è**
   ```typescript
   uploadAbortControllerRef.current = new AbortController();
   // ...
   fetch(url, {
     signal: uploadAbortControllerRef.current.signal,
   });
   ```

3. **Timeouts –∑ Promise.race**
   ```typescript
   await Promise.race([
     fetch(url, { signal }),
     new Promise((_, reject) =>
       setTimeout(() => reject(new Error("Timeout: 30s")), 30000)
     ),
   ]);
   ```

4. **Continue on error –∑–∞–º—ñ—Å—Ç—å throw**
   ```typescript
   try {
     // upload file
   } catch (error) {
     errors.push(`${filename}: ${errorMsg}`);
     continue; // ‚¨ÖÔ∏è –ø—Ä–æ–¥–æ–≤–∂—É—î–º–æ –∑ –Ω–∞—Å—Ç—É–ø–Ω–∏–º —Ñ–∞–π–ª–æ–º
   }
   ```

5. **–î–µ—Ç–∞–ª—å–Ω—ñ –ø–æ–º–∏–ª–∫–∏**
   ```typescript
   if (errorMsg.includes("Failed to fetch")) {
     errors.push(`${filename}: –ù–µ–º–∞—î –∑'—î–¥–Ω–∞–Ω–Ω—è –∑ —Å–µ—Ä–≤–µ—Ä–æ–º`);
   } else if (errorMsg.includes("Timeout")) {
     errors.push(`${filename}: ${errorMsg}`);
   }
   ```

6. **–§—ñ–Ω–∞–ª—å–Ω–∏–π –∑–≤—ñ—Ç**
   ```typescript
   if (successCount === completed.length) {
     log(`üéâ –£—Å–ø—ñ—à–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –≤—Å—ñ ${successCount} –∑–æ–±—Ä–∞–∂–µ–Ω—å`);
   } else if (successCount > 0) {
     log(`‚ö†Ô∏è –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ ${successCount} –∑ ${completed.length}`);
     throw new Error(`–ß–∞—Å—Ç–∫–æ–≤–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ: ${successCount}/${completed.length}`);
   }
   ```

### Dialog (`StorageUploadDialog.tsx`)

#### –°–∫–∞—Å—É–≤–∞–Ω–Ω—è:
```typescript
const handleCancel = () => {
  if (uploading && onCancel) {
    onCancel(); // ‚¨ÖÔ∏è –≤–∏–∫–ª–∏–∫–∞—î abort –≤ ImageProcessor
    setError("–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–∫–∞—Å–æ–≤–∞–Ω–æ");
    setUploading(false);
  }
};
```

#### UI –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è:
- –ö–Ω–æ–ø–∫–∞ "Cancel" ‚Üí "–°–∫–∞—Å—É–≤–∞—Ç–∏" (—á–µ—Ä–≤–æ–Ω–∞) –ø—ñ–¥ —á–∞—Å –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
- –ö–Ω–æ–ø–∫–∞ "Upload" ‚Üí "–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è..." –ø—ñ–¥ —á–∞—Å –ø—Ä–æ—Ü–µ—Å—É
- –ù–µ–º–æ–∂–ª–∏–≤–æ –∑–∞–∫—Ä–∏—Ç–∏ –¥—ñ–∞–ª–æ–≥ –±–µ–∑ —Å–∫–∞—Å—É–≤–∞–Ω–Ω—è –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ

### Backend (`storageUpload.js`)

#### 1. Prepare endpoint:
```javascript
// –£–Ω—ñ–∫–∞–ª—å–Ω—ñ —ñ–º–µ–Ω–∞ –¥–ª—è —É–Ω–∏–∫–Ω–µ–Ω–Ω—è –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—ñ–≤
let finalPath = tempPath;
let counter = 1;
while (fs.existsSync(finalPath)) {
  finalPath = path.join(tempDir, `${base}-${counter}${ext}`);
  counter++;
}

// Path sanitization
const safeName = path.basename(originalName);

// Cleanup on error
if (req.file && req.file.path && fs.existsSync(req.file.path)) {
  fs.unlinkSync(req.file.path);
}
```

#### 2. Upload endpoint:
```javascript
// Extended timeout (5 minutes) + larger buffer
exec(command, {
  timeout: 300000,  // 5 min –∑–∞–º—ñ—Å—Ç—å 2 min
  maxBuffer: 10 * 1024 * 1024  // 10MB
}, callback);

// Cleanup –ó–ê–í–ñ–î–ò (—É—Å–ø—ñ—Ö –∞–±–æ –ø–æ–º–∏–ª–∫–∞)
if (fs.existsSync(filePath)) {
  fs.unlinkSync(filePath);
  console.log(`üóëÔ∏è Cleaned up temp file`);
}

// –°–ø–µ—Ü–∏—Ñ—ñ—á–Ω—ñ –ø–æ–º–∏–ª–∫–∏
if (error.killed && error.signal === 'SIGTERM') {
  errorMessage = "Upload timeout (5 minutes). Check your internet connection.";
} else if (stderr && stderr.includes("ECONNREFUSED")) {
  errorMessage = "Cannot connect to storage server";
} else if (stderr && stderr.includes("ENOTFOUND")) {
  errorMessage = "Storage server not found. Check your internet connection.";
}
```

---

## üß™ –¢–µ—Å—Ç–æ–≤—ñ —Å—Ü–µ–Ω–∞—Ä—ñ—ó

### ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–æ–≤–∞–Ω–æ:

1. **–ú–Ω–æ–∂–∏–Ω–Ω—ñ —Ñ–∞–π–ª–∏ (5+ –∑–æ–±—Ä–∞–∂–µ–Ω—å)**
   - –í—Å—ñ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ
   - –ü—Ä–æ–≥—Ä–µ—Å –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î—Ç—å—Å—è `[1/5]`, `[2/5]`, —ñ —Ç.–¥.

2. **–í—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç—É**
   - Frontend: "–ù–µ–º–∞—î –∑'—î–¥–Ω–∞–Ω–Ω—è –∑ —Å–µ—Ä–≤–µ—Ä–æ–º"
   - –ù–µ –∑–∞–≤–∏—Å–∞—î, —Ç–∞–π–º–∞—É—Ç 30s

3. **–ü–æ–≤—ñ–ª—å–Ω–∏–π —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç**
   - Backend timeout 5 —Ö–≤–∏–ª–∏–Ω
   - –ü—Ä–æ–≥—Ä–µ—Å –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î—Ç—å—Å—è –≤ –ª–æ–≥–∞—Ö

4. **–°–∫–∞—Å—É–≤–∞–Ω–Ω—è –Ω–∞ —Ä—ñ–∑–Ω–∏—Ö –µ—Ç–∞–ø–∞—Ö**
   - –ù–∞—Ç–∏—Å–∫–∞–Ω–Ω—è "–°–∫–∞—Å—É–≤–∞—Ç–∏" –∑—É–ø–∏–Ω—è—î –ø—Ä–æ—Ü–µ—Å
   - Temp —Ñ–∞–π–ª–∏ –≤–∏–¥–∞–ª—è—é—Ç—å—Å—è
   - –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è "–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–∫–∞—Å–æ–≤–∞–Ω–æ"

5. **–ü–æ–º–∏–ª–∫–∞ –≤ —Å–µ—Ä–µ–¥–∏–Ω—ñ batch**
   - –Ø–∫—â–æ —Ñ–∞–π–ª #3 –∑ 5 –ø–∞–¥–∞—î, —Ñ–∞–π–ª–∏ #4 —Ç–∞ #5 –ø—Ä–æ–¥–æ–≤–∂—É—é—Ç—å –∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—Ç–∏—Å—å
   - –§—ñ–Ω–∞–ª—å–Ω–∏–π –∑–≤—ñ—Ç: "–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ 4 –∑ 5 (1 –ø–æ–º–∏–ª–∫–∞)"

6. **–ü–æ–≤—Ç–æ—Ä–Ω–µ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è Upload**
   - Blocked: "–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤–∂–µ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è"

7. **–ö–æ–Ω—Ñ–ª—ñ–∫—Ç–∏ —ñ–º–µ–Ω —Ñ–∞–π–ª—ñ–≤**
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å—Ç–≤–æ—Ä—é—é—Ç—å—Å—è —É–Ω—ñ–∫–∞–ª—å–Ω—ñ —ñ–º–µ–Ω–∞: `image-1.jpg`, `image-1-1.jpg`, —ñ —Ç.–¥.

---

## üìä –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è UX

### –î–æ:
- ‚ùå –ù–µ–º–∞—î –ø—Ä–æ–≥—Ä–µ—Å—É
- ‚ùå –ù–µ–º–æ–∂–ª–∏–≤–æ —Å–∫–∞—Å—É–≤–∞—Ç–∏
- ‚ùå –ü—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ –≤—Å—ñ —Ñ–∞–π–ª–∏ –∑—É–ø–∏–Ω—è—é—Ç—å—Å—è
- ‚ùå Generic error messages
- ‚ùå –ó–∞–≤–∏—Å–∞–Ω–Ω—è –Ω–∞ —Å–ª–∞–±–∫–æ–º—É —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç—ñ

### –ü—ñ—Å–ª—è:
- ‚úÖ –ü—Ä–æ–≥—Ä–µ—Å `[N/M]` –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ —Ñ–∞–π–ª—É
- ‚úÖ –ö–Ω–æ–ø–∫–∞ "–°–∫–∞—Å—É–≤–∞—Ç–∏" (—á–µ—Ä–≤–æ–Ω–∞, –≤–∏–¥—ñ–ª–µ–Ω–∞)
- ‚úÖ –ü—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è –ø—Ä–∏ –ø–æ–º–∏–ª–∫–∞—Ö
- ‚úÖ –°–ø–µ—Ü–∏—Ñ—ñ—á–Ω—ñ, –∑—Ä–æ–∑—É–º—ñ–ª—ñ –ø–æ–º–∏–ª–∫–∏
- ‚úÖ Timeouts –∑ —ñ–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–∏–º–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º–∏
- ‚úÖ –§—ñ–Ω–∞–ª—å–Ω–∏–π –∑–≤—ñ—Ç: X —É—Å–ø—ñ—à–Ω–æ, Y –∑ –ø–æ–º–∏–ª–∫–∞–º–∏

---

## üîí –ë–µ–∑–ø–µ–∫–∞

1. **Path traversal prevention**
   ```javascript
   const safeName = path.basename(originalName);
   ```

2. **File sanitization**
   - –í–∏–¥–∞–ª–µ–Ω–Ω—è –Ω–µ–±–µ–∑–ø–µ—á–Ω–∏—Ö —Å–∏–º–≤–æ–ª—ñ–≤
   - –í–∞–ª—ñ–¥–∞—Ü—ñ—è —Ä–æ–∑—à–∏—Ä–µ–Ω—å

3. **Resource cleanup**
   - Temp —Ñ–∞–π–ª–∏ –∑–∞–≤–∂–¥–∏ –≤–∏–¥–∞–ª—è—é—Ç—å—Å—è
   - –ù–µ–º–∞—î –≤–∏—Ç–æ–∫—É —Ä–µ—Å—É—Ä—Å—ñ–≤

---

## üöÄ –ü—ñ–¥—Å—É–º–æ–∫

–°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä **production-ready** –∑:
- ‚úÖ –ù–∞–¥—ñ–π–Ω–æ—é –æ–±—Ä–æ–±–∫–æ—é –ø–æ–º–∏–ª–æ–∫
- ‚úÖ Graceful degradation
- ‚úÖ User feedback –Ω–∞ –∫–æ–∂–Ω–æ–º—É –µ—Ç–∞–ø—ñ
- ‚úÖ –ë–µ–∑–ø–µ—á–Ω–∏–º —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è–º —Ä–µ—Å—É—Ä—Å–∞–º–∏
- ‚úÖ –ü—ñ–¥—Ç—Ä–∏–º–∫–æ—é —Å–∫–∞—Å—É–≤–∞–Ω–Ω—è
- ‚úÖ –†–æ–±–æ—Ç–æ—é –ø—Ä–∏ —Å–ª–∞–±–∫–æ–º—É —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç—ñ
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–∏–º –ª–æ–≥—É–≤–∞–Ω–Ω—è–º

–í—Å—ñ edge cases –ø–æ–∫—Ä–∏—Ç—ñ! üéâ
